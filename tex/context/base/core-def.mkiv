%D \module
%D   [       file=core-def,
%D        version=2002.05.07,
%D          title=\CONTEXT\ Core Macros,
%D       subtitle=Defaults,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA ADE \& \CONTEXT\ Development Team}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

\writestatus{loading}{ConTeXt Core Macros / Defaults}

%D Here we collect settings that cannot be done earlier due to
%D depedencies. More code will moved to this module later.

\unprotect

\usesymbols[mis,nav] % no longer mvs preloaded

\setupsymbolset[navigation 1]

\setupinteraction[\c!symbolset=navigation 1]

% initialization order:

\ifdefined\font_preloads_at_every_job  \else \let\font_preloads_at_every_job \relax \fi
\ifdefined\font_preloads_at_start_text \else \let\font_preloads_at_start_text\relax \fi
\ifdefined\font_preloads_at_stop_text  \else \let\font_preloads_at_stop_text \relax \fi

\appendtoks  \font_preloads_at_start_text          \to \everystarttext
\appendtoks  \font_preloads_at_stop_text           \to \everystoptext

\appendtoks  \showcontextbanner                    \to \everyjob
\appendtoks  \initializenewlinechar                \to \everyjob
\appendtoks  \calculatecurrenttime                 \to \everyjob
\appendtoks  \loadsystemfiles                      \to \everyjob

\appendtoks  \loadoptionfile                       \to \everyjob % obsolete
\appendtoks
    \job_options_get_commandline % expands some commands
    \job_options_get_ctxfile     % might expand some commands
\to \everyjob % ok here?

\appendtoks  \font_preloads_at_every_job           \to \everyjob
\appendtoks  \settopskip                           \to \everyjob
\appendtoks  \initializemainlanguage               \to \everyjob
\appendtoks  \xmlinitialize                        \to \everyjob % is this still needed?
\appendtoks  \setfalse\c_page_backgrounds_new      \to \everyjob
\appendtoks  \setfalse\c_page_backgrounds_some     \to \everyjob
\appendtoks  \initializepagecounters               \to \everyjob

\appendtoks  \directsetup{*runtime:options}        \to \everyjob % obsolete
\appendtoks  \directsetup{*runtime:modules}        \to \everyjob % obsolete

\appendtoks
    \job_options_set_modes
    \job_options_set_modules
    \job_options_set_environments
\to \everyjob

\appendtoks
    \job_options_log
\to \everystarttext

\appendtoks  \ifarrangingpages\poparrangedpages\fi \to \everybye

\prependtoks \resetallattributes                   \to \everybeforeoutput

\appendtoks  \the\everybackendshipout              \to \everyshipout
\prependtoks \the\everylastbackendshipout          \to \everylastshipout

\prependtoks \lefttoright                          \to \everybeforeoutput

% temporary here:

\unexpanded\def\arg{\mathortext\normalmatharg\normaltextarg}

% might move to \everydump or even disappear:

\nonknuthmode

% brrr

\appendtoks
    \synchronizegloballinespecs
    \synchronizelocallinespecs
\to \everysetupbodyfont

\appendtoks
    \synchronizelocallinespecs
\to \everyswitchtobodyfont

% who knows

% \appendtoks
%     \resetcharacterspacing
% \to \everyhyphenatedurl

\protect \endinput
