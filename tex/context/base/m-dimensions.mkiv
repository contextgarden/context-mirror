%D \module
%D   [       file=m-dimensions,
%D        version=1997.03.19,
%D          title=\CONTEXT\ Extra Modules,
%D       subtitle=Scientific Units,
%D         author={Hans Hagen},
%D           date=\currentdate,
%D      copyright={PRAGMA ADE \& \CONTEXT\ Development Team}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

\unprotect

\registerctxluafile{m-dimensions}{}

\startmodule[dimensions]

%D \macros
%D   {su}
%D
%D We have been using the units module (and its predecessor) for over a decade
%D now but when we moved on to \LUATEX\ a variant was prototyped that permits a
%D less texie coding. I finally picked up that thread and cleaned up the code a
%D bit so users can now play with it. (The main reason was that I wanted to
%D test exporting.)
%D
%D \startbuffer
%D \su{10 km/h}
%D 10\su{km/h}
%D 10 \su{km/h}
%D $10\su{km/h}$
%D $10 \su{km/h}$
%D 10 \su{KiloMeter/Hour}
%D 10 \su{kilometer/hour}
%D 10 \su{km/h}
%D 10 \su{kilometer per hour}
%D 10 \su{km / h}
%D 10 \su{ km / h }
%D 10 \su{km/ms2}
%D 10 \su{meter per second}
%D 10 \su{cubic meter}
%D 10 \su{cubic meter per second}
%D 10 \su{cubic meter / second}
%D $10 \su{cubic meter / second}$
%D 30 \su{kilo pascal }
%D 30 \su{kilo pascal square meter / second}
%D 30 \su{kilo pascal square meter / second kelvin}
%D 30 \su{crap}
%D $ \frac{10 \su{m/s}}{20 \su{m/s}} $
%D \stopbuffer
%D
%D \typebuffer
%D
%D Result: \getbuffer

\newconstant   \c_scientificunit_mode   % 0=text  1=math
\newconstant   \c_scientificunit_state  % 0=start 1=suffix 2=operator 3=unit 4=prefix 5=number
\newconditional\c_scientificunit_number

% tags and export
% smash == snapper
% hbox ook in mmode

\def\scientificunithalfspace{\thinspace}
\def\scientificunitbackspace{\negthinspace}

\newtoks \everyscientificunit % we keep the old \units command so we need a longer one

\unexpanded\def\scientificunit#1%
  {\begingroup
   \the\everyscientificunit
   \removeunwantedspaces
   \ifmmode
     \c_scientificunit_mode\plusone
     \rm\tf
     \mathtf
   \fi
   \scientificunit_indeed{#1}%
   \scientificunit_finish
   \endgroup}

\appendtoks
    \let\scientificunit\scientificunit_indeed
\to \everyscientificunit

\let\su\scientificunit

\appendtoks
    \let\su\scientificunit_indeed
\to \everyscientificunit

\unexpanded\def\scientificunit_indeed#1{\ctxcommand{scientificunit(\!!bs#1\!!es)}}

\unexpanded\def\scientificunitPUS#1#2#3{\scientificunit_next#1#2\scientificunitraise{#3}\c_scientificunit_state\plusone}   % suffix
\unexpanded\def\scientificunitPU   #1#2{\scientificunit_next#1#2\c_scientificunit_state                        \plusthree} % unit
\unexpanded\def\scientificunitPS   #1#2{\scientificunit_next#1\scientificunitraise{#2}\c_scientificunit_state  \plusone}   % suffix
\unexpanded\def\scientificunitUS   #1#2{\scientificunit_next#1\scientificunitraise{#2}\c_scientificunit_state  \plusone}   % suffix
\unexpanded\def\scientificunitP      #1{\scientificunit_next#1\c_scientificunit_state                          \plusfour}  % prefix
\unexpanded\def\scientificunitU      #1{\scientificunit_next#1\c_scientificunit_state                          \plusthree} % unit
\unexpanded\def\scientificunitS      #1{\scientificunit_start{}\scientificunitraise{#1}\c_scientificunit_state \plusone}   % suffix
\unexpanded\def\scientificunitO      #1{\scientificunit_start#1\c_scientificunit_state                         \plustwo}   % operator
\unexpanded\def\scientificunitN      #1{\scientificunit_start#1\c_scientificunit_state                         \plusfive}  % number

\setelementnature[unit]    [mixed]
\setelementnature[quantity][mixed]

\unexpanded\def\scientificunitN#1%
  {\ifmmode
     #1%
   \else
     \dostarttagged{quantity}\empty
     \dostarttagged{number}\empty
     #1%
     \dostoptagged
     \settrue\c_scientificunit_number
   \fi
  %\scientificunit_start
   \c_scientificunit_state\plusfive}

\def\scientificunit_start
  {\ifmmode
     \dostarttagged\t!mathaction{unit}%
     \bgroup % make an mrow
   \else
     \dostarttagged{unit}\empty
   \fi
   \let\scientificunit_finish\scientificunit_stop
   \let\scientificunit_start\relax}

\def\scientificunit_stop
  {\ifmmode
     \egroup
   \fi
   \ifconditional\c_scientificunit_number
     \dostoptagged
   \fi
   \dostoptagged}

\def\scientificunitraise
  {\ifnum\c_scientificunit_mode=\plusone
     \expandafter\normalsuperscript
   \else
     \expandafter\high
   \fi}

\def\scientificunitlower
  {\ifnum\c_scientificunit_mode=\plusone
     \expandafter\normalsubscript
   \else
     \expandafter\low
   \fi}

\unexpanded\def\scientificunit_next
  {\ifcase\c_scientificunit_state % start
     \scientificunithalfspace
     \scientificunithalfspace
   \or % suffix
     {\cdot}% \scientificunithalfspace
   \or % operator
   \or % unit
     {\cdot}% \scientificunithalfspace
   \or % prefix
   \or % number
     \scientificunithalfspace
     \scientificunithalfspace
   \fi
   \scientificunit_start}

\unexpanded\def\scientificunitTIMES
  {\ifnum\c_scientificunit_state=\plusone % suffix
   \else
     \scientificunithalfspace
   \fi
   \cdot} % or \times

\unexpanded\def\scientificunitOUTOF
  {\ifnum\c_scientificunit_state=\plusone % suffix
   \else
     \scientificunithalfspace
   \fi
   :}

\unexpanded\def\scientificunitSOLIDUS
  {\ifnum\c_scientificunit_state=\plusone % suffix
     \scientificunitbackspace
   \fi
   {/}%
   }%\scientificunitbackspace}

\stopmodule

\protect \endinput
