%D \module
%D   [       file=pack-com, % used to be in core-mis,
%D        version=20120111,
%D          title=\CONTEXT\ Packing Macros,
%D       subtitle=Combinations,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA ADE \& \CONTEXT\ Development Team}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

\writestatus{loading}{ConTeXt Packaging Macros / Combinations}

\unprotect

%D We could of course map combinations onto one of the table
%D mechanisms but as it has served us well for ages we keep
%D this one. The code has been cleaned up a bit and mkiv'd.
%D
%D Okay ... I might luafy this one eventually.

% \startcombination      {alpha} {a} {beta} {b} \stopcombination
% \startcombination[2*1] {alpha} {a} {beta} {b} \stopcombination
% \startcombination[1*2] {alpha} {a} {beta} {b} \stopcombination
% \startcombination[2]   {alpha} {a} {beta} {b} \stopcombination

% todo: \startcombination \startcomb \stopcomb ...

\ifdefined\dotagcombination \else \let\dotagcombination\relax \fi

\newsystemmode{combination}

\appendtoks
    \global\resetsystemmode{combination}%
\to \everyinsidefloat

\newcount\c_pack_combinations_x
\newcount\c_pack_combinations_n
\newcount\c_pack_combinations_max
\newbox  \b_pack_combinations_captions
\newbox  \b_pack_combinations_content
\newbox  \b_pack_combinations_caption
\newbox  \b_pack_combinations_temp % global

\installcorenamespace{combination}

\installcommandhandler \??combination {combination} \??combination

\setupcombination
  [\c!width=\v!fit,
   \c!height=\v!fit,
   \c!distance=\emwidth,
   \c!location=\v!bottom, % can be something {top,left}
   \c!before=\blank,
   \c!inbetween={\blank[\v!medium]},
  %\c!style=,
  %\c!color=,
  %\c!after=,
   \c!align=\v!middle]

\let\setupcombinations\setupcombination % for the moment (we might distinguish)

\installcorenamespace{combinationlocation}

\let\m_pack_combinations_rightfiller\hfil
\let\m_pack_combinations_leftfiller \hfil
\let\m_pack_combinations_valigner   \firstofoneargument

\setvalue{\??combinationlocation\v!left  }{\let\m_pack_combinations_leftfiller\relax}
\setvalue{\??combinationlocation\v!right }{\let\m_pack_combinations_rightfiller\relax}
\setvalue{\??combinationlocation\v!top   }{\let\m_pack_combinations_valigner\depthonlybox}
\setvalue{\??combinationlocation\v!middle}{\let\m_pack_combinations_valigner\halfwaybox}

\def\pack_combinations_location_step#1%
  {\csname\??combinationlocation#1\endcsname}

\unexpanded\def\startcombination
  {\bgroup % so we can grab a group
   \dodoubleempty\pack_combinations_start}

% formally ok:
%
% \unexpanded\def\stopcombination
%   {\egroup
%    \egroup}
%
% more robust:
%
% \unexpanded\def\stopcombination
%   {{}{}{}{}{}{}{}{}% catches (at most 4) missing entries
%    \egroup
%    \egroup}
%
% even better:
%
% \unexpanded\def\stopcombination
%   {\bgroup
%    \scratchtoks{{}}%
%    \dorecurse\c_pack_combinations_n
%      {\scratchtoks\expandafter{\the\scratchtoks{}{}}}%
%    \expandafter\egroup\the\scratchtoks
%    \egroup
%    \dostoptagged
%    \egroup}
%
% faster

\unexpanded\def\stopcombination
  {\bgroup\normalexpanded{\egroup{}\ctxcommand{ntimes("{}{}",\number\c_pack_combinations_n)}}%
   \dostoptagged
   \egroup
   \egroup}

\def\pack_combinations_start[#1][#2]% needs a cleanup, also nx ny (pretty old, this one)
  {\global\setsystemmode{combination}%
   %
%    \doifnothing{#1}\firstargumentfalse      % to be sure (when called in macros)
%    \doifnothing{#2}\secondargumentfalse     % to be sure (when called in macros)
%    \ifsecondargument % todo: nx ny
%      \edef\currentcombination{#1}%
%      \edef\currentcombinationspec{#2*\plusone*}%
%    \else % better : \doifcombinationelse ... \??co#1\c!location
%      \doifinstringelse{*}{#1}
%        {\let\currentcombination\empty
%         \edef\currentcombinationspec{#1*\plusone*}}
%        {\doifnumberelse{#1}
%           {\let\currentcombination\empty
%            \edef\currentcombinationspec{#1*\plusone*}}
%           {\edef\currentcombination{#1}%
%            \edef\currentcombinationspec{\plustwo*\plusone*}}}%
%    \fi
   %
   % todo : move split to here
   %
   \edef\currentcombination{#1}%
   \edef\currentcombinationspec{#2}%
   \ifx\currentcombinationspec\empty
     \doifinstringelse{*}\currentcombination
       {\edef\currentcombinationspec{\currentcombination*\plusone*}%
        \let\currentcombination\empty}
       {\doifnumberelse\currentcombination
          {\edef\currentcombinationspec{\currentcombination*\plusone*}%
           \let\currentcombination\empty}
          {\edef\currentcombinationspec{\plustwo*\plusone*}}}%
   \else
     \edef\currentcombinationspec{\currentcombinationspec*\plusone*}%
   \fi
   %
   \forgetall
   %
   \edef\p_height  {\combinationparameter\c!height}%
   \edef\p_width   {\combinationparameter\c!width}%
   \edef\p_location{\combinationparameter\c!location}%
   \edef\p_align   {\combinationparameter\c!align}%
   \edef\p_distance{\combinationparameter\c!distance}%
   %
   \let\m_pack_combinations_rightfiller\relax
   \let\m_pack_combinations_leftfiller \relax
   \let\m_pack_combinations_valigner   \vbox
   \processcommacommand[\p_location]\pack_combinations_location_step
   %
   \dostarttagged\t!combination\currentcombination
   \vbox \ifx\p_height\v!fit\else to \p_height \fi \bgroup
   \let\combination\empty % permits \combination{}{} handy for cld
   \setuphorizontaldivision[\c!n=\v!fit,\c!distance=\p_distance]%
   \normalexpanded{\pack_combinations_start_indeed[\currentcombinationspec]}}

\unexpanded\def\pack_combinations_start_indeed[#1*#2*#3]%
  {\global\c_pack_combinations_x#1\relax
   \global\c_pack_combinations_n#2\relax
   \dotagcombination
   \global\setbox\b_pack_combinations_captions\emptybox
   \global\c_pack_combinations_max\c_pack_combinations_x
   \multiply\c_pack_combinations_n\c_pack_combinations_x
   \tabskip\zeropoint
   \halign \ifx\p_width\v!fit\else to \p_width \fi \bgroup
   \aligntab
   \m_pack_combinations_leftfiller
   \alignmark\alignmark
   \m_pack_combinations_rightfiller
   \aligntab
   \tabskip\zeropoint \!!plus 1fill
   \alignmark\alignmark
   \cr
   \pack_combinations_pickup}

\def\pack_combinations_pickup % we want to add struts but still ignore an empty box
  {\dostarttagged\t!combinationpair\empty
   \dostarttagged\t!combinationcontent\empty
   \dowithnextboxcs\pack_combinations_pickup_content\hbox}

\def\pack_combinations_pickup_content % we want to add struts but still ignore an empty box
  {\dostoptagged
   \setbox\b_pack_combinations_content\box\nextbox
   \dostarttagged\t!combinationcaption\empty
   \dowithnextboxcs\pack_combinations_pickup_caption\vtop\bgroup
     \afterassignment\pack_combinations_caption_first
     \let\nexttoken=}

\def\pack_combinations_pickup_caption
  {\dostoptagged
   \dostoptagged
   \setbox\b_pack_combinations_caption\box\nextbox
   \pack_combinations_pickup_package_pair}

\def\pack_combinations_caption_first
  {\futurelet\nexttoken\pack_combinations_caption_second}

\def\pack_combinations_caption_second
  {\ifx\nexttoken\egroup
     % the caption is empty
   \else
     \hsize\wd\b_pack_combinations_content
     \ifx\p_align\empty\else\setupalign[\p_align]\fi
     \usecombinationstyleandcolor\c!style\c!color
     \bgroup
     \aftergroup\endstrut
     \aftergroup\egroup
     \begstrut
   \fi}

\def\pack_combinations_pickup_package_pair % we need to store the caption row
  {\vbox
     {\forgetall
      \m_pack_combinations_valigner{\copy\b_pack_combinations_content}%
      % we need to save the caption for a next alignment line
      \pack_combinations_save_caption}%
   \ifnum\c_pack_combinations_n>\plusone
     \global\advance\c_pack_combinations_n\minusone
     \global\advance\c_pack_combinations_x\minusone
     \ifcase\c_pack_combinations_x
       \doubleexpandafter\pack_combinations_pickup_package_pair_a
     \else
       \doubleexpandafter\pack_combinations_pickup_package_pair_b
     \fi
   \else
     \singleexpandafter\pack_combinations_pickup_package_pair_c
   \fi}

\def\pack_combinations_pickup_package_pair_a
  {\cr
   \pack_combinations_flush_captions
   \noalign
     {\forgetall
      \global\setbox\b_pack_combinations_captions\emptybox
      \nointerlineskip
      \combinationparameter\c!after
      \combinationparameter\c!before
      \vss
      \nointerlineskip}%
   \global\c_pack_combinations_x\c_pack_combinations_max
   \pack_combinations_pickup}

\def\pack_combinations_pickup_package_pair_b
  {\aligntab
   \aligntab
   \aligntab
   \hskip\p_distance
   \aligntab
   \pack_combinations_pickup}

\def\pack_combinations_pickup_package_pair_c
  {\cr
   \pack_combinations_flush_captions
   \egroup}

\def\pack_combinations_save_caption
  {\global\setbox\b_pack_combinations_captions\hbox
     {\hbox{\box\b_pack_combinations_caption}%
      \unhbox\b_pack_combinations_captions}}

\def\pack_combinations_flush_captions
  {\noalign
     {\ifdim\ht\b_pack_combinations_captions>\zeropoint
        \nointerlineskip % indeed
        \combinationparameter\c!inbetween
        \global\c_pack_combinations_x\c_pack_combinations_max
        \globallet\pack_combinations_flush_captions_indeed\pack_combinations_flush_captions_yes
      \else
        \global\setbox\b_pack_combinations_captions\emptybox
        \globallet\pack_combinations_flush_captions_indeed\pack_combinations_flush_captions_nop
      \fi}%
   \pack_combinations_flush_captions_indeed
   \crcr}

\def\pack_combinations_flush_captions_yes
  {\global\setbox\b_pack_combinations_captions\hbox
     {\unhbox\b_pack_combinations_captions
      \global\setbox\b_pack_combinations_temp\lastbox}%
   \box\b_pack_combinations_temp
   \global\advance\c_pack_combinations_x\minusone\relax
   \ifnum\c_pack_combinations_x>\zerocount
     \expandafter\pack_combinations_flush_captions_yes_followup
   \else
     \global\setbox\b_pack_combinations_captions\emptybox
   \fi}

\let\pack_combinations_flush_captions_nop\donothing

\def\pack_combinations_flush_captions_yes_followup
  {\aligntab
   \aligntab
   \aligntab
   \aligntab
   \pack_combinations_flush_captions_indeed}

%D \macros
%D   {startfloatcombination}
%D
%D \setupexternalfigures[directory={../sample}]
%D \startbuffer
%D \placefigure
%D   [left,none]
%D   {}
%D   {\startfloatcombination[2*2]
%D      \placefigure{alpha}{\externalfigure[cow.pdf][width=1cm]}
%D      \placefigure{beta} {\externalfigure[cow.pdf][width=2cm]}
%D      \placefigure{gamma}{\externalfigure[cow.pdf][width=3cm]}
%D      \placefigure{delta}{\externalfigure[cow.pdf][width=4cm]}
%D    \stopfloatcombination}
%D
%D \input tufte
%D \stopbuffer
%D
%D \typebuffer \getbuffer

\unexpanded\def\startfloatcombination
  {\dodoubleempty\pack_combinations_start_float}

\let\stopfloatcombination\relax

\def\pack_combinations_start_float[#1][#2]%
  {\vbox\bgroup
  %\insidecolumnstrue % trick, forces no centering, todo: proper switch/feature
   \postcenterfloatmethod\zerocount
   \forcelocalfloats
   \unexpanded\def\stopfloatcombination{\pack_combinations_stop_float{#1}}}

\def\pack_combinations_stop_float#1%
  {\scratchtoks\emptytoks
   \dorecurse\noflocalfloats
     {\appendetoks{\noexpand\getlocalfloat{\recurselevel}}{}\to\scratchtoks}% brrr
   \expanded{\startcombination[#1]\the\scratchtoks}\stopcombination
   \resetlocalfloats
  \egroup}


\protect \endinput
