%D \module
%D   [       file=publ-ini,
%D        version=2013.05.12,
%D          title=\CONTEXT\ Publication Support,
%D       subtitle=Initialization,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA ADE \& \CONTEXT\ Development Team}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

% todo: tagging
% todo: we cannot use 'default' as this wipes metadata names (maybe no longer do that)
% todo: \v!cite => \s!cite
% todo: interface with (ml)bibtex (export -> call -> import)
% todo: check if 'all' etc are ok ... either use list or use other criterium
% todo: \the\everysetupbtxciteplacement probably too often

% \definecolor[btx:field]   [darkred]
% \definecolor[btx:crossref][darkblue]
% \definecolor[btx:key]     [darkgreen]
% \definecolor[btx:todo]    [darkyellow]

%D We operate on several axis:
%D
%D \startitemize[packed]
%D \startitem we can have several databases (or combinations) \stopitem
%D \startitem we can add entries to them if needed (coded in tex) \stopitem
%D \startitem we can have several lists each using one of the databases \stopitem
%D \startitem we can render each list or citation independently \stopitem
%D \stopitemize
%D
%D We assume that the rendering of a list entry is consistent in a document,
%D although one can redefine properties if needed. Adding more granularity would
%D complicate the user interface beyond comprehension.

\writestatus{loading}{ConTeXt Publication Support / Initialization}

\registerctxluafile{publ-dat}{1.001}
\registerctxluafile{publ-aut}{1.001}
\registerctxluafile{publ-usr}{1.001}
\registerctxluafile{publ-ini}{1.001}
\registerctxluafile{publ-oth}{1.001} % this could become an option
\registerctxluafile{publ-fnd}{1.001} % new method (for the moment only local)
\registerctxluafile{publ-jrn}{1.001}
\registerctxluafile{publ-reg}{1.001}

\unprotect

\startcontextdefinitioncode

\def\s!btx          {btx}

\def\v!btxcite      {btxcite}
\def\v!btxlist      {btxlist}
\def\v!btxrendering {btxrendering}

\def\s!btxset       {btxset}
\def\s!btxref       {btxref}
\def\s!btxint       {btxint}
\def\s!btxbck       {btxbck}
\def\s!btxltx       {btxltx}
\def\s!btxrtx       {btxrtx}

\definelabelclass[btxlabel][2]

% It is not that trivail to come up with a proper organization of setup
% and control commands for publications. This is because we have complex
% inline as well as extensive list rendering. The rules are partially
% driven by somewhat archaic bibtex specifications and evolving journal
% (or field) specific demands. The logic in the standards is often so
% complex that it looks like manual rendering is assumed. But, we want to
% automate the process as much as possible.
%
% Another complication is that in manuals we want to demonstate different
% properties of the implementation and therefore we need a way to handle
% independent standards, databases, etc. This has resulted in the following
% organization:
%
% - general setup (rather minimal)
% - list setup (rendering)
% - cite setup
% - dataset setup
%
% The rendering is mostly driven by setups. In there we can call for fields
% in the database but also for virtual fields or combinations.

% The main rendering style (standard driven).

\installcorenamespace {btx}

\installsetuphandler \??btx {btx}
% \installcommandhandler \??btx {btx} \??btx

% \setupbtx
%   [\c!alternative=apa]

% \newconstant\btxmode
% \newconstant\btxnonemode
% \newconstant\btxcitemode
% \newconstant\btxlistmode

%D Loading variants:

\let\currentbtxrenderingdefinition\empty
\let\currentbtxalternative        \empty

\unexpanded\def\startbtxrenderingdefinitions[#1]%
  {\pushmacro\currentbtxrenderingdefinition
   \edef\currentbtxrenderingdefinition{#1}%
   \letvalue{\??btxrenderingdefinition\currentbtxrenderingdefinition}\currentbtxrenderingdefinition}

\unexpanded\def\stopbtxrenderingdefinitions
  {\popmacro\currentbtxrenderingdefinition}

\unexpanded\def\loadbtxdefinitionfile[#1]%
  {\ctxcommand{loadbtxdefinitionfile("#1")}}

% \appendtoks
%     \loadbtxdefinitionfile[\btxrenderingparameter\c!alternative]
% \to \everysetupbtxrendering

\let\currentbtxalternative\empty

\appendtoks
    \edef\currentbtxalternative{\btxrenderingparameter\c!alternative}%
    \ifcsname\??btxrenderingdefinition\currentbtxalternative\endcsname
        % maybe fall back on apa ?
    \else
        \loadbtxdefinitionfile[\currentbtxalternative]%
        \showmessage\m!publications{14}{\currentbtxalternative}%
    \fi
\to \everysetupbtx

\def\btx_set_rendering_alternative
  {\ctxcommand{setbtxspecification("\currentbtxalternative")}}

% a dedicated construction mechanism

\installcorenamespace {btxlist}

\installcommandhandler \??btxlist {btxlist} \??btxlist

\unexpanded\setvalue{\??constructioninitializer\v!btxlist}%
  {\let\currentbtxlist                  \currentconstruction
   \let\constructionparameter           \btxlistparameter
   \let\constructionnamespace           \??btxlist
   \let\detokenizedconstructionparameter\detokenizedbtxlistparameter
   \let\letconstructionparameter        \letbtxlistparameter
   \let\useconstructionstyleandcolor    \usebtxliststyleandcolor
   \let\setupcurrentconstruction        \setupcurrentbtxlist}

\expandafter\let\csname\??constructionmainhandler   \v!btxlist\expandafter\endcsname\csname\??constructionmainhandler   \v!construction\endcsname
\expandafter\let\csname\??constructioncommandhandler\v!btxlist\expandafter\endcsname\csname\??constructioncommandhandler\v!construction\endcsname
\expandafter\let\csname\??constructiontexthandler   \v!btxlist\expandafter\endcsname\csname\??constructiontexthandler   \v!construction\endcsname

\unexpanded\setvalue{\??constructioncommandhandler\v!btxlist}%
  {\csname\??constructionstarthandler\v!construction\endcsname
   \csname\??constructionstophandler \v!construction\endcsname
   \endgroup}

\unexpanded\def\startbtxlistentry#1%
  {\begingroup
   \strc_constructions_initialize{#1}%
   \csname\??constructionstarthandler\currentconstructionhandler\endcsname}

\unexpanded\def\stopbtxlistentry
  {\csname\??constructionstophandler\currentconstructionhandler\endcsname}

% interactivity is handled in setups

\unexpanded\setvalue{\??constructiontexthandler\v!btxlist}%
  {\begingroup
   \fastsetup{\v!btxrendering:\v!number:\constructionparameter\c!number}%
   \endgroup}

% the whole entry can be interactive

\unexpanded\setvalue{\??constructionstarthandler\v!btxlist}%
  {\csname\??constructionstarthandler\v!construction\endcsname
   \ifx\currentbtxnumbering\v!no\else
     \ifx\currentbtxinternal\empty \else
       \startgoto[\s!internal(\currentbtxinternal)]%
     \fi
   \fi}

\unexpanded\setvalue{\??constructionstophandler\v!btxlist}%
  {\ifx\currentbtxnumbering\v!no\else
     \ifx\currentbtxinternal\empty \else
       \stopgoto
     \fi
   \fi
   \csname\??constructionstophandler\v!construction\endcsname
   \endgroup}

\startsetups[\v!btxrendering:\v!number:\v!no]
    % \btx_reference_checked % needs testing
\stopsetups

\startsetups[\v!btxrendering:\v!number:\v!yes]
   \useconstructionstyleandcolor\c!headstyle\c!headcolor % move to \currentconstructiontext
   \the\everyconstruction
   \relax
   \strut
   \constructionparameter\c!text
   \btx_list_reference_inject
   \relax
\stopsetups

% construction (todo:low level builder commands without using the constructor)

\unexpanded\def\strc_constructions_initialize#1% class instance
  {\edef\currentconstruction{#1}%
   \let\currentconstructionlistentry\!!zerocount
   \expandafter\let\expandafter\currentconstructionmain   \csname\??constructionmain \currentconstruction\endcsname
   \expandafter\let\expandafter\currentconstructionlevel  \csname\??constructionlevel\currentconstruction\endcsname
   \expandafter\let\expandafter\currentconstructionhandler\csname\??constructionclass\currentconstruction\endcsname
   \csname\??constructioninitializer\currentconstructionhandler\endcsname}

\appendtoks
  % \ifx\currentbtxlistparent\empty
  %     \defineconstruction[\currentbtxlist][\currentbtxlistparent][\s!handler=\v!btxlist,\c!level=1]%
  % \else
  %     \defineconstruction[\currentbtxlist][\s!handler=\v!btxlist,\c!level=1]%
  % \fi
    \ifx\currentbtxlistparent\empty
        \letvalue{\??constructionmain\currentbtxlist}\currentbtxlist
    \else
        \letvalue{\??constructionmain\currentbtxlist}\currentbtxlistparent
    \fi
    \setevalue{\??constructionlevel\currentbtxlist}{\number\btxlistparameter\c!level}%
    \setevalue{\??constructionclass\currentbtxlist}{\btxlistparameter\s!handler}%
\to \everydefinebtxlist

\setupbtxlist
  [\s!handler=\v!btxlist,
   \c!level=1]

\setupbtxlist
  [\c!alternative=\v!left,
   \c!headstyle=,
   \c!titlestyle=,
  %\c!style=,
  %\c!color=,
  %\c!headcolor=,
  %\c!titlecolor=,
   \c!width=4\emwidth,
   \c!distance=\emwidth,
  %\c!titledistance=.5\emwidth,
  %\c!hang=,
  %\c!sample=,
  %\c!align=,
  %\c!headalign=,
   \c!margin=\v!no,
   \c!before=\blank,
   \c!inbetween=\blank,
   \c!after=\blank,
  %\c!indentnext=\v!yes,
  %\c!indenting=\v!never,
  %\c!titleleft=(,
  %\c!titleright=),
  %\c!closesymbol=,
  %\c!closecommand=\wordright,
   \c!display=\v!yes,
   \c!command=,
  %\c!titlecommand=,
  %\c!expansion=\v!no,
  %\c!xmlsetup=,
  %\s!catcodes=,
  %\c!title=\v!yes,
  %\c!text=,
  \c!number=\v!yes,
  ]

% here starts the bib stuff

\installcorenamespace {btxdataset}
\installcorenamespace {btxlistvariant}
\installcorenamespace {btxcitevariant}
\installcorenamespace {btxrendering}
\installcorenamespace {btxregister}
\installcorenamespace {btxcommand}
\installcorenamespace {btxrenderingdefinition}

\installcommandhandler \??btxdataset     {btxdataset}     \??btxdataset
\installcommandhandler \??btxlistvariant {btxlistvariant} \??btxlistvariant
\installcommandhandler \??btxcitevariant {btxcitevariant} \??btxcitevariant
\installcommandhandler \??btxregister    {btxregister}    \??btxregister
\installcommandhandler \??btxrendering   {btxrendering}   \??btxrendering

\appendtoks
    \ifx\currentbtxlistvariant\empty \else
        \ctxcommand{registerbtxlistvariant("\currentbtxlistvariant","\currentbtxlistvariantparent")}%
    \fi
\to \everydefinebtxlistvariant

\appendtoks
    \ifx\currentbtxcitevariant\empty \else
        \ctxcommand{registerbtxcitevariant("\currentbtxcitevariant","\currentbtxcitevariantparent")}%
    \fi
\to \everydefinebtxcitevariant

\unexpanded\def\usebtxdataset
  {\dodoubleargument\publ_use_dataset}

\def\publ_use_dataset[#1][#2]%
  {\ifsecondargument
     \ctxcommand{usebtxdataset("#1","#2")}%
   \else
     \ctxcommand{usebtxdataset("\v!standard","#1")}%
   \fi}

\definebtxdataset
  [\v!standard]
% [\c!language=] % nothing set so use current

% \usebtxdataset
%   [standard]
%   [mybibs.bib]

\unexpanded\def\startpublication
  {\dodoubleempty\publ_set_publication}

\let\stoppublication\relax

\def\publ_set_publication[#1][#2]%
  {\begingroup
   \catcode\commentasciicode\othercatcode
   \ifsecondargument
     \expandafter\publ_set_publication_indeed
   \else\iffirstargument
     \doubleexpandafter\publ_set_publication_checked
   \else
     \doubleexpandafter\publ_set_publication_default
   \fi\fi{#1}{#2}}

\def\publ_set_publication_default#1#2%
  {\publ_set_publication_indeed\v!standard{#1}}

\def\publ_set_publication_checked#1#2%
  {\doifassignmentelse{#1}
     {\publ_set_publication_indeed\v!standard{#1}}
     {\publ_set_publication_indeed{#1}{}}}

\def\publ_set_publication_indeed#1#2#3\stoppublication
  {\ctxcommand{addbtxentry("#1",\!!bs#2\!!es,\!!bs\detokenize{#3}\!!es)}%
   \endgroup
   \ignorespaces}

% commands

\unexpanded\def\btxcommand#1%
  {\ifcsname\??btxcommand#1\endcsname
     \expandafter\publ_command_yes
   \else
     \expandafter\publ_command_nop
   \fi{#1}}

\let\btxcmd\btxcommand

\def\publ_command_yes#1%
  {\csname\??btxcommand#1\endcsname}

\def\publ_command_nop#1%
  {\ifcsname#1\endcsname
     \showmessage\m!publications{10}{#1,#1}%
    %\setuxvalue{\??btxcommand#1}{\expandafter\noexpand\csname#1\endcsname}%
     \global\expandafter\let\csname\??btxcommand#1\expandafter\endcsname\csname#1\endcsname
   \else\ifcsname\utfupper{#1}\endcsname
     \showmessage\m!publications{10}{#1}{\utfupper{#1}}%
    %\setuxvalue{\??btxcommand#1}{\expandafter\noexpand\csname\utfupper{#1}\endcsname}%
     \global\expandafter\let\csname\??btxcommand#1\expandafter\endcsname\csname\utfupper{#1}\endcsname
   \else
     \showmessage\m!publications{11}{#1}%
     \setugvalue{\??btxcommand#1}{\underbar{\tttf#1}}%
   \fi\fi
   \publ_command_yes{#1}}

\unexpanded\def\definebtxcommand#1% {body} #1..#n{body}
  {\setuvalue{\??btxcommand\strippedcsname#1}}%

% tracing

\installtextracker
  {publications.crosslinks}
  {\let\btx_trace_list_cross\strc_references_tracer}
  {\let\btx_trace_list_cross\gobbletwoarguments}

\let\btx_trace_list_cross\gobbletwoarguments

% access

\let\currentbtxtag    \empty
\let\currentbtxdataset\v!standard

\unexpanded\def\setbtxdataset[#1]%
  {\edef\currentbtxdataset{\ctxcommand{setbtxdataset("#1","\currentbtxdataset")}}}

\unexpanded\def\setbtxentry[#1]%
  {\edef\currentbtxtag{\ctxcommand{setbtxentry("\currentbtxdataset","#1")}}}

% \let\btxsetdataset\setbtxdataset
% \let\btxsetentry  \setbtxentry

% todo: no need for the currents as we can keep them at the lua end so we will have
%
% \btxfield         : current
% \btxspecificfield : dataset,tag,key

\def\btxfield      #1{\ctxcommand{btxfield("\currentbtxdataset","\currentbtxtag","#1")}}
\def\btxdetail     #1{\ctxcommand{btxdetail("\currentbtxdataset","\currentbtxtag","#1")}}
\def\btxauthorfield#1{\ctxcommand{btxauthorfield(\number\currentbtxauthorindex,"#1")}}
\def\btxflush      #1{\ctxcommand{btxflush("\currentbtxdataset","\currentbtxtag","#1")}}
\def\btxdoifelse   #1{\ctxcommand{btxdoifelse("\currentbtxdataset","\currentbtxtag","#1")}}
\def\btxdoif       #1{\ctxcommand{btxdoif("\currentbtxdataset","\currentbtxtag","#1")}}
\def\btxdoifnot    #1{\ctxcommand{btxdoifnot("\currentbtxdataset","\currentbtxtag","#1")}}

\let\btxsetup\fastsetup

%D How complex will we go? Can we assume that e.g. an apa style will not be mixed
%D with another one? I think this assumption is okay. For manuals we might want to
%D mix but we can work around it.

%D Rendering.

\unexpanded\def\btxspace                 {\removeunwantedspaces\space}
\unexpanded\def\btxnobreakspace          {\removeunwantedspaces\nobreakspace} % these two are
\unexpanded\def\btxnbsp                  {\removeunwantedspaces\nbsp}         % the same anyway
\unexpanded\def\btxperiod                {\removeunwantedspaces.\space}
\unexpanded\def\btxcomma                 {\removeunwantedspaces,\space}
\unexpanded\def\btxcolon                 {\removeunwantedspaces:\space}
\unexpanded\def\btxsemicolon             {\removeunwantedspaces;\space}
\unexpanded\def\btxlparent               {\removeunwantedspaces\space(} % obsolete
\unexpanded\def\btxrparent               {\removeunwantedspaces)\space} % obsolete
\unexpanded\def\btxleftparenthesis       {\removeunwantedspaces\space(}
\unexpanded\def\btxrightparenthesis      {\removeunwantedspaces)\space}
\unexpanded\def\btxrightparenthesisperiod{\removeunwantedspaces).\space}
\unexpanded\def\btxrightparenthesiscomma {\removeunwantedspaces),\space}
\unexpanded\def\btxleftbracket           {\removeunwantedspaces\space[}
\unexpanded\def\btxrightbracket          {\removeunwantedspaces]\space}
\unexpanded\def\btxrightbracketperiod    {\removeunwantedspaces].\space}
\unexpanded\def\btxrightbracketcomma     {\removeunwantedspaces],\space}

%D Variables:

\let\currentbtxbacklink     \empty    \unexpanded\def\btxsetbacklink     {\def\currentbtxbacklink}
\let\currentbtxbacktrace    \empty    \unexpanded\def\btxsetbacktrace    {\def\currentbtxbacktrace}
\let\currentbtxcategory     \empty    \unexpanded\def\btxsetcategory     {\def\currentbtxcategory}
\let\currentbtxcombis       \empty    \unexpanded\def\btxsetcombis       {\def\currentbtxcombis}
\let\currentbtxdataset      \empty    \unexpanded\def\btxsetdataset      {\def\currentbtxdataset}
\let\currentbtxfirst        \empty    \unexpanded\def\btxsetfirst        {\def\currentbtxfirst}
\let\currentbtxsecond       \empty    \unexpanded\def\btxsetsecond       {\def\currentbtxsecond}
\let\currentbtxthird        \empty    \unexpanded\def\btxsetthird        {\def\currentbtxthird}
\let\currentbtxinternal     \empty    \unexpanded\def\btxsetinternal     {\def\currentbtxinternal}
\let\currentbtxlefttext     \empty    \unexpanded\def\btxsetlefttext     {\def\currentbtxlefttext}
\let\currentbtxrighttext    \empty    \unexpanded\def\btxsetrighttext    {\def\currentbtxrighttext}
\let\currentbtxlanguage     \empty    \unexpanded\def\btxsetlanguage     {\def\currentbtxlanguage}
\let\currentbtxtag          \empty    \unexpanded\def\btxsettag          {\def\currentbtxtag}
\let\currentbtxnumber       \empty    \unexpanded\def\btxsetnumber       {\def\currentbtxnumber}
\let\currentbtxauthorvariant\v!normal \unexpanded\def\btxsetauthorvariant{\def\currentbtxauthorvariant}

%let\currentbtxfirstnames   \empty    \unexpanded\def\btxsetfirstnames   {\def\currentbtxfirstnames}
%let\currentbtxinitials     \empty    \unexpanded\def\btxsetinitials     {\def\currentbtxinitials}
%let\currentbtxjuniors      \empty    \unexpanded\def\btxsetjuniors      {\def\currentbtxjuniors}
%let\currentbtxsurnames     \empty    \unexpanded\def\btxsetsurnames     {\def\currentbtxsurnames}
%let\currentbtxvons         \empty    \unexpanded\def\btxsetvons         {\def\currentbtxvons}

%unexpanded\def\getcurrentbtxfirstnames{\ctxcommand{btxauthorfield("firstnames")}
%unexpanded\def\getcurrentbtxinitials  {\ctxcommand{btxauthorfield("initials")}
%unexpanded\def\getcurrentbtxjuniors   {\ctxcommand{btxauthorfield("juniors")}
%unexpanded\def\getcurrentbtxsurnames  {\ctxcommand{btxauthorfield("surnames")}
%unexpanded\def\getcurrentbtxvons      {\ctxcommand{btxauthorfield("vons")}

\unexpanded\def\currentbtxfirstnames_indeed{\ctxcommand{btx_a_f(\number\currentbtxauthorindex)}}
\unexpanded\def\currentbtxinitials_indeed  {\ctxcommand{btx_a_i(\number\currentbtxauthorindex)}}
\unexpanded\def\currentbtxjuniors_indeed   {\ctxcommand{btx_a_j(\number\currentbtxauthorindex)}}
\unexpanded\def\currentbtxsurnames_indeed  {\ctxcommand{btx_a_s(\number\currentbtxauthorindex)}}
\unexpanded\def\currentbtxvons_indeed      {\ctxcommand{btx_a_v(\number\currentbtxauthorindex)}}

\let\currentbtxfirstnames   \empty    \unexpanded\def\btxsetfirstnames{\let\currentbtxfirstnames\currentbtxfirstnames_indeed}
\let\currentbtxinitials     \empty    \unexpanded\def\btxsetinitials  {\let\currentbtxinitials  \currentbtxinitials_indeed  }
\let\currentbtxjuniors      \empty    \unexpanded\def\btxsetjuniors   {\let\currentbtxjuniors   \currentbtxjuniors_indeed   }
\let\currentbtxsurnames     \empty    \unexpanded\def\btxsetsurnames  {\let\currentbtxsurnames  \currentbtxsurnames_indeed  }
\let\currentbtxvons         \empty    \unexpanded\def\btxsetvons      {\let\currentbtxvons      \currentbtxvons_indeed      }

\newconstant\currentbtxoverflow    \unexpanded\def\btxsetoverflow   #1{\currentbtxoverflow   #1\relax}
\newconstant\currentbtxconcat      \unexpanded\def\btxsetconcat     #1{\currentbtxconcat     #1\relax}
\newconstant\currentbtxcount       \unexpanded\def\btxsetcount      #1{\currentbtxcount      #1\relax}
\newconstant\currentbtxauthorindex %unexpanded\def\btxsetauthorindex#1{\currentbtxauthorindex#1\relax} % passed directly
\newconstant\currentbtxauthorcount %unexpanded\def\btxsetauthorcount#1{\currentbtxauthorcount#1\relax} % passed directly
\newconstant\currentbtxauthorstate \unexpanded\def\btxsetauthorstate#1{\currentbtxauthorstate#1\relax}

\def\currentbtxauthorvariant{normal}

\unexpanded\def\btxlistreset
  {\let\currentbtxcombis   \empty
   \let\currentbtxcategory \empty
   \let\currentbtxinternal \empty
   \let\currentbtxlefttext \empty
   \let\currentbtxrighttext\empty
   \let\currentbtxbacklink \empty
   \let\currentbtxbacktrace\empty
   \let\currentbtxlanguage \empty
   \let\currentbtxtag      \empty
   \let\currentbtxnumber   \empty
   \let\currentbtxdataset  \empty}

\unexpanded\def\btxcitereset % check for less .. not all resets needed
  {\let        \currentbtxfirst      \empty
   \let        \currentbtxsecond     \empty
   \let        \currentbtxinternal   \empty
   \let        \currentbtxbacklink   \empty
   \let        \currentbtxbacktrace  \empty % not used here
   \let        \currentbtxlanguage   \empty
   \let        \currentbtxdataset    \empty
   \let        \currentbtxtag        \empty
   \let        \currentbtxnumber     \empty
   \setconstant\currentbtxoverflow   \zerocount
   \setconstant\currentbtxconcat     \zerocount
   \setconstant\currentbtxcount      \zerocount}

%D Tracing

\newconditional\c_btx_trace

\installtextracker
  {btxrendering}
  {\settrue \c_btx_trace}
  {\setfalse\c_btx_trace}

%D Rendering lists and citations.

\unexpanded\def\startbtxrendering
  {\begingroup
   \dosingleempty\btx_start_rendering}

\def\btx_start_rendering[#1]%
  {\edef\currentbtxrendering{#1}%
   \btxrenderingparameter\v!before}

\unexpanded\def\stopbtxrendering
  {\btxrenderingparameter\v!after
   \endgroup}

\unexpanded\def\btxtodo#1%
  {[#1]}

%D Lists:

\newdimen\d_publ_number_width
%newdimen\d_publ_number_distance

\ifdefined\btxblock       \else \newcount\btxblock       \fi \btxblock\plusone
\ifdefined\btxcitecounter \else \newcount\btxcitecounter \fi % maybe pass this to lua

\newtoks \everysetupbtxlistplacement % name will change
\newtoks \everysetupbtxciteplacement % name will change

% \def\publ_list_processor % bibref -> btx (old method, keep as reference)
%   {\ctxcommand{btxaddtolist("\currentbtxrendering",\currentlistindex,"btxref")}}

\definelist % only used for selecting
  [\s!btx]

\setuplist
  [\s!btx]
  [\c!state=\v!start]

\appendtoks
    \ifx\currentbtxrenderingparent\empty
        \definebtxlist
          [\currentbtxrendering]%
    \else
        \definebtxlist
          [\currentbtxrendering]%
          [\currentbtxrenderingparent]%
    \fi
\to \everydefinebtxrendering

\unexpanded\def\btx_entry_inject
  {\begingroup
   \edef\currentbtxcategory{\btxfield{category}}%
   \ignorespaces
   \edef\currentbtxsetup{\s!btx:\currentbtxalternative:\currentbtxcategory}%
   \doifsetupselse\currentbtxsetup
     \btx_entry_inject_yes
     \btx_entry_inject_nop
   \endgroup}

\def\btx_entry_inject_yes
  {\ifx\currentbtxlefttext\empty\else
     \fastsetup{\s!btx:\currentbtxalternative:lefttext}%
   \fi
   \fastsetup\currentbtxsetup
   \removeunwantedspaces
   \ifx\currentbtxcombis\empty \else
     \btxrenderingparameter\c!separator
     \processcommacommand[\currentbtxcombis]\btx_entry_inject_combi
   \fi
   \ifx\currentbtxrighttext\empty\else
     \fastsetup{\s!btx:\currentbtxalternative:righttext}%
   \fi}

\def\btx_entry_inject_nop
  {\tttf \getmessage\m!publications{12}{\currentbtxsetup}}

\def\btx_entry_inject_combi#1%
  {\begingroup
   \def\currentbtxtag{#1}%
   \ignorespaces
   \fastsetup{\s!btx:\currentbtxalternative:\currentbtxcategory}%
   \removeunwantedspaces
   \endgroup}

\unexpanded\def\completebtxrendering{\dodoubleempty\publ_place_list_complete}
\unexpanded\def\placebtxrendering   {\dodoubleempty\publ_place_list_standard}

\let\completelistofpublications\completebtxrendering
\let\placelistofpublications   \placebtxrendering

\newtoks\everybtxlistrendering

\appendtoks
    \let\currentlist\s!btx
    \let\currentbtxlist\currentbtxrendering
    %
    \edef\currentbtxcriterium{\btxrenderingparameter\c!criterium}% \v!cite will become \s!cite
    \ifx\currentbtxcriterium\empty
        \let\currentbtxcriterium\v!previous
    \else\ifx\currentbtxcriterium\v!cite
        \let\currentbtxcriterium\v!here
    \fi\fi
    %
    \iflocation
        \letinteractionparameter\c!style\empty
    \fi
\to \everybtxlistrendering

\def\publ_place_list_complete[#1][#2]% title might become obsolete, just headtext
  {\begingroup
   \ifsecondargument
     \edef\currentbtxrendering{#1}%
     \setupcurrentbtxrendering[#2]%
   \else\iffirstargument
     \let\currentbtxrendering\currentbtxdataset
     \setupcurrentbtxrendering[#1]%
   \fi\fi
   \the\everybtxlistrendering
   \edef\currentbtxrenderingtitle{\btxrenderingparameter\c!title}%
   \ifx\currentbtxrenderingtitle\empty
     \normalexpanded{\startnamedsection[\v!chapter][\c!reference=\currentbtxrendering,\c!title={\headtext{\currentbtxrendering}}]}%
   \else
     \normalexpanded{\startnamedsection[\v!chapter][\c!reference=\currentbtxrendering,\c!title={\currentbtxrenderingtitle}]}%
   \fi
   \publ_place_list_indeed
   \stopnamedsection
   \endgroup}

\def\publ_place_list_standard[#1][#2]%
  {\begingroup
   \ifsecondargument
     \edef\currentbtxrendering{#1}%
     \setupcurrentbtxrendering[#2]%
   \else\iffirstargument
     \let\currentbtxrendering\currentbtxdataset
     \setupcurrentbtxrendering[#1]%
   \fi\fi
   \the\everybtxlistrendering
   \publ_place_list_indeed
   \endgroup}

\def\publ_place_list_indeed
  {\startbtxrendering[\currentbtxrendering]%
   % \fastsetup{\btxrenderingparameter\c!setups}% specific initializations
   % \determinelistcharacteristics[\currentbtxrendering]%
     \btx_set_rendering_alternative
     \edef\currentbtxdataset{\btxrenderingparameter\c!dataset}%
     \uselanguageparameter\btxdatasetparameter % new
     \let\currentlist\s!btx
     \let\currentbtxlist\currentbtxrendering
     \the\everysetupbtxlistplacement
     \forgetall
     % why not pass this with collect .. todo
     \startpacked[\v!blank]%
       % here we just collect items
       \ctxcommand{btxcollectlistentries {
           names      = "btx",
           criterium  = "\currentbtxcriterium",
           method     = "\btxrenderingparameter\c!method",
           number     = "\btxrenderingparameter\c!number",
           btxdataset = "\currentbtxdataset",
           keyword    = "\btxrenderingparameter\c!keyword",
           sorttype   = "\btxrenderingparameter\c!sorttype",
           repeated   = "\btxrenderingparameter\c!repeat",
       }}%
       % sorting and so
       \ctxcommand{btxpreparelistentries("\currentbtxdataset")}%
       % next we analyze the width
       \ifx\currentbtxnumbering\empty \else
         \edef\p_width{\btxrenderingparameter\c!width}%
         \ifx\p_width\v!auto
           \setbox\scratchbox\vbox \bgroup
             \settrialtypesetting
             \ctxcommand{btxfetchlistentries("\currentbtxdataset")}%
           \egroup
           \d_publ_number_width\wd\scratchbox
           \letbtxlistparameter\c!width\d_publ_number_width
         \fi
       \fi
       % this actually typesets them
       \ctxcommand{btxflushlistentries("\currentbtxdataset")}%
     \stoppacked
   \stopbtxrendering
   \global\advance\btxblock\plusone}

\def\currentbtxblock{\number\btxblock}

\unexpanded\def\btxsetlanguage#1%
  {\def\currentbtxlanguage{#1}%
   \ifx\currentbtxlanguage\currentlanguage \else
      \setcurrentlanguage\currentmainlanguage\currentbtxlanguage
   \fi}

% called at the lua end, for determining the width

\unexpanded\def\btxchecklistentry
  {\begingroup
   % todo, switch to font
   \hbox{\btx_reference_checked}%
   \par
   \endgroup}

% called at the lua end, the real rendering

\unexpanded\def\btxhandlelistentry
  {\begingroup
   \let\currentlist\s!btx % probably obsolete here
   \startbtxlistentry\currentbtxrendering
     \btx_entry_inject
   \stopbtxlistentry
   \endgroup}

\unexpanded\def\btxlistsetup#1%
  {\fastsetup{\s!btx:\s!list:#1}}

\unexpanded\def\btx_reference_indeed
  {\begingroup
   \let\currentbtxlistvariant\currentbtxnumbering
   \btxlistvariantparameter\c!left
   \ctxcommand{btxlistvariant("\currentbtxdataset","\currentbtxblock","\currentbtxtag","\currentbtxnumbering","\currentbtxnumber")}% some can go
   \btxlistvariantparameter\c!right
   \endgroup}

\unexpanded\def\btx_reference_checked
  {\dontleavehmode\hbox\bgroup
     \btx_reference_indeed
   \egroup}

\newcount\c_btx_list_reference

\unexpanded\def\btx_list_reference_inject
  {\dontleavehmode\begingroup % no box
     \iftrialtypesetting\else
       \btx_list_reference_inject_now
     \fi
     \btx_reference_indeed
   \endgroup}

\def\btx_list_reference_inject_now
  {\btx_trace_list_cross\empty\currentbtxbacktrace
   \global\advance\c_btx_list_reference\plusone
   \strc_references_direct_full_user
      {\s!btxset="\currentbtxdataset",%
       \s!btxref="\currentbtxtag",%
       \ifx\currentbtxbacklink\currentbtxbacktrace\s!btxint="\currentbtxbacklink"\else\s!btxbck="\currentbtxbacktrace"\fi}%
      {\s!btx::\v!list::\number\c_btx_list_reference}%
      {\currentbtxnumber}}

\unexpanded\def\btx_cite_reference_inject
  {\dontleavehmode
   \iftrialtypesetting \else
     \ifx\currentbtxbacklink\empty
       % can be made empty when combining author / year
     \else
       \btx_cite_reference_inject_indeed
     \fi
  \fi}

\newtoks\t_btx_reference_inject

\def\btx_cite_reference_inject_indeed
  {\btx_trace_list_cross\currentbtxbacklink\empty
   \the\t_btx_reference_inject
   \normalexpanded{\writedatatolist
      [\s!btx]%
      [\s!btxset=\currentbtxdataset,%
       \s!btxref=\currentbtxtag,%
       \ifx\p_publ_cite_lefttext \empty\else\s!btxltx={\p_publ_cite_lefttext },\fi%
       \ifx\p_publ_cite_righttext\empty\else\s!btxrtx={\p_publ_cite_righttext},\fi%
       \s!btxint=\number\currentbtxbacklink
       \ifx\currentbtxciteuservariables\empty\else,\currentbtxciteuservariables\fi]}}

\def\currentbtxuservariable #1{\ctxcommand{btxuservariable("\currentbtxdataset","#1")}}
\def\btxdoifelseuservariable#1{\ctxcommand{btxdoifelseuservariable("\currentbtxdataset","#1")}}

\let\btxcitereference\btx_cite_reference_inject

\let\currentbtxnumbering\empty

\appendtoks
   \edef\currentbtxnumbering{\btxrenderingparameter\c!numbering}%
   \letlistparameter\c!numbercommand\firstofoneargument % for the moment, no doubling needed
   \ifx\currentbtxnumbering\v!no
     \letlistparameter\c!textcommand\outdented % needed? we can use titlealign
     \letlistparameter\c!symbol     \v!none
     \letlistparameter\c!aligntitle \v!yes
     \let\currentbtxnumbering\empty
   \else
     \letlistparameter\c!headnumber\v!always
   \fi
\to \everysetupbtxlistplacement

% \appendtoks
%     \edef\currentbtxcriterium{\btxrenderingparameter\c!criterium}%
% \to \everysetupbtxlistplacement

\unexpanded\def\btxflushauthor
  {\doifnextoptionalcselse\btx_flush_author_yes\btx_flush_author_nop}

\def\btx_flush_author_yes[#1]{\btx_flush_author{#1}}
\def\btx_flush_author_nop    {\btx_flush_author{\btxlistvariantparameter\c!author}}

\unexpanded\def\btx_flush_author#1#2%
  {\begingroup
   \edef\currentbtxfield{#2}%
   \let\currentbtxlistvariant\currentbtxfield
   \ctxcommand{btxauthor("\currentbtxdataset","\currentbtxtag","\currentbtxfield",{
        combiner    = "#1",
        kind        = "list",
      % symbol      = ".",
        etallimit   = \number\btxlistvariantparameter\c!etallimit,
        etaldisplay = \number\btxlistvariantparameter\c!etaldisplay,
   })}%
   \endgroup}

\unexpanded\def\btxflushauthorname         {\btx_flush_author{name}}          % #1
\unexpanded\def\btxflushauthornormal       {\btx_flush_author{normal}}        % #1
\unexpanded\def\btxflushauthornormalshort  {\btx_flush_author{normalshort}}   % #1
\unexpanded\def\btxflushauthorinverted     {\btx_flush_author{inverted}}      % #1
\unexpanded\def\btxflushauthorinvertedshort{\btx_flush_author{invertedshort}} % #1

\unexpanded\def\currentbtxciteauthor % always author
  {\begingroup
   \ctxcommand{btxauthor("\currentbtxdataset","\currentbtxtag","author",{
        combiner    = "\btxcitevariantparameter\c!authorconversion",
        kind        = "cite",
      % symbol      = ".",
        etallimit   = \number\btxcitevariantparameter\c!etallimit,
        etaldisplay = \number\btxcitevariantparameter\c!etaldisplay,
   })}%
   \endgroup}

\unexpanded\def\btxstartauthor#1#2#3%
  {\begingroup
   \currentbtxauthorindex#1\relax
   \currentbtxauthorcount#2\relax
   \currentbtxauthorstate#3\relax}

\unexpanded\def\btxstopauthor
  {\endgroup}

\unexpanded\def\btxciteauthorsetup#1{\fastsetup{\s!btx:\s!cite:\s!author:#1}}
\unexpanded\def\btxlistauthorsetup#1{\fastsetup{\s!btx:\s!list:\s!author:#1}}

% \btxflushauthor{author}
% \btxflushauthor{artauthor}
% \btxflushauthor{editor}
%
% \btxflushauthor[name]{author}
% \btxflushauthor[normal]{author}
% \btxflushauthor[normalshort]{author}
% \btxflushauthor[inverted]{author}
% \btxflushauthor[invertedshort]{author}

% \btxflushauthor{author}
% \btxflushauthor{artauthor}
% \btxflushauthor{editor}
%
% \btxflushauthor[name]{author}
% \btxflushauthor[normal]{author}
% \btxflushauthor[normalshort]{author}
% \btxflushauthor[inverted]{author}
% \btxflushauthor[invertedshort]{author}

% Interaction: only list

\newconditional\btxinteractive

\unexpanded\def\btxdoifelseinteraction{\secondoftwoarguments}

\appendtoks
    \iflocation
        \edef\p_interaction{\btxlistvariantparameter\c!interaction}%
        \ifx\p_interaction\v!stop
            \let\btxdoifelseinteraction\secondoftwoarguments
            \setfalse\btxinteractive
        \else
            \let\btxdoifelseinteraction\firstoftwoarguments
            \settrue\btxinteractive
        \fi
    \else
        \let\btxdoifelseinteraction\secondoftwoarguments
        \setfalse\btxinteractive
    \fi
\to \everysetupbtxlistplacement

\appendtoks
    \iflocation
        \edef\p_interaction{\btxcitevariantparameter\c!interaction}%
        \ifx\p_interaction\v!stop
            \let\btxdoifelseinteraction\secondoftwoarguments
            \setfalse\btxinteractive
        \else
            \let\btxdoifelseinteraction\firstoftwoarguments
            \settrue\btxinteractive
        \fi
    \else
        \let\btxdoifelseinteraction\secondoftwoarguments
        \setfalse\btxinteractive
    \fi
\to \everysetupbtxciteplacement

\appendtoks
    % for old times sake, for a while at least
    \let\maybeyear\gobbleoneargument
    \let\noopsort \gobbleoneargument
\to \everysetupbtxlistplacement

\appendtoks
    % for old times sake, for a while at least
    \let\maybeyear\gobbleoneargument
    \let\noopsort \gobbleoneargument
\to \everysetupbtxciteplacement

% till here

\unexpanded\def\btxnumberedreference[#1]% \bibtexnumref (replaced by \cite[num])
  {\dontleavehmode
   \begingroup
   \btxcitevariantparameter\v!left
   \penalty\plustenthousand % todo
   \ctxcommand{btxresolvelistreference("\currentbtxdataset","#1")}% todo: split dataset from #1, so another call
   \btxcitevariantparameter\v!right
   \endgroup}

%D When a publication is cited, we need to signal that somehow. This is done with the
%D following (not user) command. We could tag without injecting a node but this way
%D we also store the location, which makes it possible to ask local lists.

%D \macros{cite,nocite,citation,nocitation,usecitation}
%D
%D The inline \type {\cite} command creates a (often) short reference to a publication
%D and for historic reasons uses a strict test for brackets. This means, at least
%D in the default case that spaces are ignored in the argument scanner. The \type
%D {\citation} commands is more liberal but also gobbles following spaces. Both
%D commands insert a reference as well as a visual clue.
%D
%D The \type {no} commands all do the same (they are synonyms): they make sure that
%D a reference is injected but show nothing. However, they do create a node so best
%D attach them to some text in order to avoid spacing interferences. A slightly
%D less efficient alternative is \type {\cite[none][tag]}.

% [tags]
% [settings|variant][tags]
% [base::tags]
% [settings|variant][base::tags]

% these need to be sort of protected:

%let\p_publ_cite_before   \empty
%let\p_publ_cite_after    \empty
\let\p_publ_cite_lefttext \empty
\let\p_publ_cite_righttext\empty

\let\currentbtxciteuservariables\empty

% \unexpanded\def\btxcite
%   {\dontleavehmode
%    \begingroup
%    \strictdoifnextoptionalelse\publ_cite_tags_options\publ_cite_tags_indeed}
%
% \unexpanded\def\publ_cite_tags_options[#1]%
%   {\strictdoifnextoptionalelse{\publ_cite_tags_options_indeed{#1}}{\publ_cite_tags_indeed{#1}}}

\unexpanded\def\publ_cite_tags_indeed#1%
  {\letinteractionparameter\c!style\empty
   \edef\currentbtxcitevariant{\btxcitevariantparameter\c!alternative}%
   \edef\currentbtxcitetag{#1}%
   \the\everysetupbtxciteplacement
   \publ_cite_variant
   \endgroup}

\unexpanded\def\publ_cite_tags_options_indeed#1%
  {\doifassignmentelse{#1}\publ_cite_tags_settings_indeed\publ_cite_tags_variants_indeed{#1}}

\def\publ_cite_tags_settings_indeed#1[#2]%
  {\letinteractionparameter\c!style\empty
  %\letinteractionparameter\c!color\empty
   \letdummyparameter\c!reference  \empty
   \letdummyparameter\c!extras     \empty
   \letdummyparameter\c!alternative\empty
   %letdummyparameter\c!before     \empty
   %letdummyparameter\c!after      \empty
   \letdummyparameter\c!lefttext   \empty
   \letdummyparameter\c!righttext  \empty
   \getdummyparameters[#1]%
   \edef\p_reference{\dummyparameter\c!reference}%
   \ifx\p_reference\empty
      \edef\currentbtxcitetag{#2}%
   \else
      \let\currentbtxcitetag\p_reference
      \edef\currentbtxciteuservariables{#2}%
   \fi
   \edef\p_alternative{\dummyparameter\c!alternative}%
   \ifx\p_alternative\empty
     \edef\currentbtxcitevariant{\btxcitevariantparameter\c!alternative}%
   \else
     \let\currentbtxcitevariant\p_alternative
   \fi
   \setupcurrentbtxcitevariant[#1]%
   \edef\p_extras{\dummyparameter\c!extras}%
   \ifx\p_extras\empty \else
     \edef\p_right{\btxcitevariantparameter\c!right}%
     \ifx\p_right\empty \else
       \setexpandedbtxcitevariantparameter\p_right{\p_extras\p_right}%
     \fi
   \fi
   %edef\p_publ_cite_before   {\dummyparameter\c!before}%
   %edef\p_publ_cite_after    {\dummyparameter\c!after}%
   \edef\p_publ_cite_lefttext {\dummyparameter\c!lefttext}%
   \edef\p_publ_cite_righttext{\dummyparameter\c!righttext}%
   \the\everysetupbtxciteplacement
   %ifx\p_publ_cite_before\empty \else
   % \p_publ_cite_before
   % \space
   %fi
   \publ_cite_variant
   %ifx\p_publ_cite_after\empty \else
   % \optionalspace
   % \p_publ_cite_after
   %fi
   \endgroup}

\def\publ_cite_tags_variants_indeed#1[#2]%
  {\letinteractionparameter\c!style\empty
   \edef\currentbtxcitevariant{#1}%
   \edef\currentbtxcitetag{#2}%
   \the\everysetupbtxciteplacement
   \publ_cite_variant
   \endgroup}

\newconditional\btxcitecompress

\def\publ_cite_variant
  {\begingroup
   \publ_cite_handle_variant_indeed[\currentbtxcitetag]}

\unexpanded\def\publ_cite_handle_variant#1%
  {\begingroup
   \edef\currentbtxcitevariant{#1}%
   \the\everysetupbtxciteplacement
   \dosingleargument\publ_cite_handle_variant_indeed}

\def\publ_cite_handle_variant_indeed[#1]%
  {\usebtxcitevariantstyleandcolor\c!style\c!color
   \uselanguageparameter\btxdatasetparameter % new
   \letbtxcitevariantparameter\c!alternative\currentbtxcitevariant
   \btxcitevariantparameter\v!left
   \ctxcommand{btxhandlecite{%
     dataset   = "\currentbtxdataset",%
     reference = "#1",%
     markentry = \iftrialtypesetting false\else true\fi,%
     variant   = "\currentbtxcitevariant",%
     sorttype  = "\btxcitevariantparameter\c!sorttype",%
     compress  = "\btxcitevariantparameter\c!compress",%
     author    = "\btxcitevariantparameter\c!author",%
   }}%
   \btxcitevariantparameter\v!right
   \ctxcommand{flushmarked()}%
   \endgroup}

\unexpanded\def\btxcitation
  {\dontleavehmode
   \begingroup
   \dodoubleempty\publ_citation}

\def\publ_citation[#1][#2]% could be made more efficient but not now
  {\ifsecondargument
     \publ_cite_tags_options_indeed{#1}[#2]%
   \else
     \publ_cite_tags_indeed{#1}%
   \fi}

\unexpanded\def\btxnocitation
  {\dosingleempty\publ_cite_no}

\unexpanded\def\publ_cite_no[#1]%
  {\iftrialtypesetting \else
     \ctxcommand{btxhandlenocite{%
       dataset   = "\currentbtxdataset",%
       reference = "#1",%
       markentry = true,%
     }}%
   % \ctxcommand{flushmarked()}%
   \fi}

\unexpanded\def\btxmissing#1%
  {\dontleavehmode{\tttf<#1>}}

%D Compatibility:

\let\cite          \btxcitation
\let\citation      \btxcitation
\let\nocite        \btxnocitation
\let\nocitation    \btxnocitation
%let\usepublication\btxnocitation

%D Cite helpers:

\unexpanded\def\btxcitesetup#1%
  {\fastsetup{\s!btx:\s!cite:#1}} % no \btxcitereset as we loose dataset and such

\unexpanded\def\btxstartsubcite#1% #1 can go
  {\begingroup
   \btxcitereset % todo: limited set
   \def\currentbtxcitevariant{#1}%
   \btxcitevariantparameter\c!left
   \relax}

\unexpanded\def\btxstopsubcite
  {\relax
   \btxcitevariantparameter\c!right
   \endgroup}

\let\btxstartcite      \begingroup
\let\btxstopcite       \endgroup
\let\btxstartciteauthor\begingroup
\let\btxstopciteauthor \endgroup

%D Whatever helpers:

\unexpanded\def\btxsingularplural#1{\ctxcommand{btxsingularorplural("\currentbtxdataset","\currentbtxtag","#1")}}
\unexpanded\def\btxoneorrange    #1{\ctxcommand{oneorrange("\currentbtxdataset","\currentbtxtag","#1")}}
\unexpanded\def\btxfirstofrange  #1{\ctxcommand{firstofrange("\currentbtxdataset","\currentbtxtag","#1")}}

\let\btxsingularorplural\btxsingularplural

\stopcontextdefinitioncode

%D Journals

\unexpanded\def\btxloadjournallist [#1]{\ctxcommand{btxloadjournallist("#1")}}
\unexpanded\def\btxsavejournallist [#1]{\ctxcommand{btxsavejournallist("#1")}}
\unexpanded\def\btxaddjournal  [#1][#2]{\ctxcommand{btxaddjournal("#1"."#2")}}
           \def\btxexpandedjournal   #1{\ctxcommand{btxexpandedjournal("#1")}}    % \unexpanded ?
           \def\btxabbreviatedjournal#1{\ctxcommand{btxabbreviatedjournal("#1")}} % \unexpanded ?

% \installcorenamespace{btxjournal}
%
% \letvalue{\s!btxjournal\v!long  }\btxexpandedjournal
% \letvalue{\s!btxjournal\v!short }\btxabbreviatedjournal
% \letvalue{\s!btxjournal\v!normal}\firstofoneargument
%
% \unexpanded\def\btxcheckedjournal
%   {\expandnamespaceparameter\s!btxjournal\btxrenderingparameter\c!journalconversion}

% \btxloadjournallist[list.txt] % Foo Journal of Bars = FBJ \n ....
%
% \btxexpandedjournal[fbj]
% \btxabbreviatedjournal[foo journal of bars]

%D Saving data:

\unexpanded\def\savebtxdataset
  {\dotripleargument\publ_save_dataset}

\unexpanded\def\publ_save_dataset[#1][#2][#3]%
  {\begingroup
   \getdummyparameters[\c!criterium=\v!all,\c!alternative=,#3]% % all or used
   \ctxcommand{btxsavedataset("#1","#2","\dummyparameter\c!alternative","\dummyparameter\c!criterium")}%
   \endgroup}

% \savebtxdataset[standard][e:/tmp/foo.bib]
% \savebtxdataset[standard][e:/tmp/foo.lua]
% \savebtxdataset[standard][e:/tmp/foo.xml]

%D In-text entries:

% \unexpanded\def\placecitation
%   {\dodoubleempty\publ_place_citation}
%
% \unexpanded\def\publ_place_citation
%   {\ifsecondargument
%      \expandafter\publ_place_citation_two
%    \else\iffirstargument
%      \doubleexpandafter\publ_place_citation_one
%    \else
%      \doubleexpandafter\publ_place_citation_zero
%    \fi\fi}
%
% \unexpanded\def\publ_place_citation_one[#1][#2]%
%   {\publ_place_citation_two[\currentbtxrendering][#1]}
%
% \unexpanded\def\publ_place_citation_two[#1][#2]%
%   {\dontleavehmode
%    \begingroup
%      \startbtxrendering[#1]%
%      \btx_set_rendering_alternative
%      \edef\currentbtxdataset{\btxrenderingparameter\c!dataset}%
%      \uselanguageparameter\btxdatasetparameter % new
%      \ctxcommand{btxflushlistentry{ dataset = "\currentbtxdataset", reference = \!!bs#2\!!es }}%
%      \btxcitereference % we need a proper setup
%      \stopbtxrendering
%    \endgroup}
%
% \unexpanded\def\publ_place_citation_zero[#1][#2]%
%   {\btxmissing{??}}
%
% \let\btxhandlelisttextentry\btx_entry_inject

\unexpanded\def\placecitation{\citation[entry]} % [#1]


\unexpanded\def\btxhandleciteentry
  {\dontleavehmode
   \begingroup
   \btx_set_rendering_alternative
   \btxcitereference
   \btx_entry_inject
   \endgroup}

\startsetups \s!btx:\s!cite:entry
    \ifx\currentbtxfirst\empty
        \fastsetup{\s!btx:\s!cite:\s!unknown}
    \else
        \btxhandleciteentry
    \fi
\stopsetups

%D Registers

% \setupbtxregister
%   [\c!state=\v!start,
%    \c!dataset=\v!all,
%    \c!method=\v!always]

\unexpanded\def\publ_registers_set
  {\ifx\currentbtxregister\empty \else
     \ctxcommand{setbtxregister {
        name        = "\currentbtxregister",
        state       = "\btxregisterparameter\c!state",
        dataset     = "\btxregisterparameter\c!dataset",
        field       = "\btxregisterparameter\c!field",
        register    = "\btxregisterparameter\c!register",
        method      = "\btxregisterparameter\c!method",
     %  alternative = "\btxregisterparameter\c!alternative",
    }}%
  \fi}

\appendtoks
    \publ_registers_set
\to \everydefinebtxregister

\appendtoks
    \publ_registers_set
\to \everysetupbtxregister

\appendtoks
    \normalexpanded{%
      \defineprocessor
        [\s!btx:r:\currentbtxregister]%
        [\c!style=\noexpand\namedbtxregisterparameter{\currentbtxregister}\noexpand\c!style,
         \c!color=\noexpand\namedbtxregisterparameter{\currentbtxregister}\noexpand\c!color]}%
\to \everydefinebtxregister

\appendtoks
    \ctxcommand{btxtoregister("\currentbtxdataset","\currentbtxtag")}%
\to \t_btx_reference_inject

% \unexpanded\def\dosetfastregisterentry#1#2#3% register entry key
%   {\begingroup
%    \edef\currentregister{#1}%
%    \setnextinternalreference
%    \xdef\currentregisternumber{\ctxcommand{storeregister{
%         metadata   = { name = "\currentregister" },
%         entries    = { { \!!bs#2\!!es }, { \!!bs#3\!!es } },
%      }
%    }}%
%    \xdef\currentregistersynchronize{\ctxlatecommand{enhanceregister("\currentregister",\currentregisternumber)}}%
%    \currentregistersynchronize % here?
%    \dostarttagged\t!registerlocation\currentregister
%    \attribute\destinationattribute\lastdestinationattribute \signalcharacter % no \strut as it will be removed during cleanup
%    \dotagregisterlocation
%    \dostoptagged
%    \endgroup}

% \unexpanded\def\btx_flush_specific_field#1#2#3#4#5% dataset tag field variant value
%   {\begingroup
%    \edef\currentbtxdataset{#1}%
%    \edef\currentbtxtag    {#2}%
%    \edef\currentbtxfield  {#3}%
%    \let\currentbtxlistvariant\currentbtxfield
%    \edef\currentbtxcitevariant{#4}%
%    \usebtxregisterstyleandcolor\c!style\c!color
%    \edef\tempstring{\currentbtxalternative:register:\currentbtxcitevariant}%
%    \doifsetupselse\tempstring{\fastsetup\tempstring}{#5}%
%    \endgroup}

% \unexpanded\def\btx_flush_specific_author#1#2#3#4#5% dataset tag field variantindex
%   {\begingroup
%    \edef\currentbtxdataset{#1}%
%    \edef\currentbtxtag    {#2}%
%    \edef\currentbtxfield  {#3}%
%    \let\currentbtxlistvariant\currentbtxfield
%    \edef\currentbtxcitevariant{#4}%
%    \ctxcommand{btxauthor("\currentbtxdataset","\currentbtxtag","\currentbtxfield",{
%         kind     = "list",
%         index    = \number#5,
%         combiner = "\currentbtxcitevariant",
%    })}%
%    \endgroup}

% \let\dobtxindexedfield \btx_flush_specific_field  % used at lua end
% \let\dobtxindexedauthor\btx_flush_specific_author % used at lua end

\unexpanded\def\dobtxindexedfield#1% value
  {\begingroup
   \usebtxregisterstyleandcolor\c!style\c!color
   #1%
   \endgroup}

%D Defaults:

\setbtxdataset
  [\v!standard]

\setupbtxrendering
  [\c!dataset=\v!standard,
   \c!repeat=\v!no,
   \c!continue=\v!no,
   \c!method=\v!global,
 % \c!setups=btx:\btxrenderingparameter\c!alternative:initialize, % not the same usage as cite !
   \c!alternative=apa,
   \c!sorttype=,
   \c!criterium=\v!text,
   \c!refcommand=authoryears,  % todo
   \c!numbering=\v!yes,
 % \c!autohang=\v!no, % not used
   \c!width=\v!auto,
   \c!separator={; },
   \c!distance=1.5\emwidth]

\definebtxrendering
  [\v!standard]

\setupbtxcitevariant
  [\c!interaction=\v!start,
 % \c!setups=btx:cite:initialize,
   \c!alternative=num,
   \c!authorconversion=\v!normal,
 % \c!andtext={ \btxlabeltext{\currentbtxalternative:and} },
   \c!otherstext={ \btxlabeltext{\currentbtxalternative:others}},
   \c!pubsep={, },
   \c!lastpubsep={ \btxlabeltext{\currentbtxalternative:and} },
   \c!finalpubsep={ \btxlabeltext{\currentbtxalternative:and} },
   \c!compress=\v!no,
   \c!inbetween={ },
   \c!range=\endash,
   \c!left=,
   \c!middle=,
   \c!right=]

% \c!authorconversion=\v!normal

\definebtxcitevariant
   [author]
   [%c!sorttype=,
    \c!left={(},
    \c!middle={, },
    \c!right={)}]

\definebtxcitevariant
   [authornum]
   [author]
   [\c!inbetween={ }]

\definebtxcitevariant
   [authoryear]
   [\c!compress=\v!yes,
    \c!inbetween={, },
    \c!left={(},
    \c!middle={, },
    \c!right={)}]

\definebtxcitevariant
   [authoryears]
   [authoryear]

\definebtxcitevariant
   [author:num]
   [authornum]
   [\c!left={[},
    \c!right={]}]

\definebtxcitevariant
   [author:year]
   [authoryear]
   [\c!left=,
    \c!right=]

% \definebtxcitevariant
%    [author:years]
%    [authoryears]
%    [\c!left=,
%     \c!right=]

\definebtxcitevariant
   [author:years]
   [author:year]

\definebtxcitevariant
   [year]
   [\c!left={(},
    \c!middle={, }, % is middle used?
    \c!right={)}]

\definebtxcitevariant
   [title]
   [\c!middle={, }]

\definebtxcitevariant
   [tag]
   [\c!left={[},
    \c!middle={, },
    \c!right={]}]

\definebtxcitevariant
   [key]
   [tag]

\definebtxcitevariant
   [serial]
   [\c!left={[},
    \c!middle={, },
    \c!right={]}]

\definebtxcitevariant
   [page]
   [\c!left={[},
    \c!middle={, },
    \c!right={]}]

\definebtxcitevariant
   [pages]
   [page]

\definebtxcitevariant
   [short]
   [\c!left={[},
    \c!middle={, },
    \c!right={]}]

\definebtxcitevariant
   [category]
   [\c!left={[},
    \c!middle={, },
    \c!right={]}]

\definebtxcitevariant
   [type]
   [category]

\definebtxcitevariant
   [doi]
   [\c!left={[},
    \c!middle={, },
    \c!right={]}]

\definebtxcitevariant
   [url]
   [\c!left={[},
    \c!middle={, },
    \c!right={]}]

\definebtxcitevariant
   [page]
   [\c!left=,
    \c!middle={, },
    \c!right=]

\definebtxcitevariant
   [num]
   [\c!compress=\v!yes,
    \c!left={[},
    \c!middle={, },
    \c!right={]}]

\setupbtxlistvariant
  [\c!namesep={, },
   \c!lastnamesep={ \btxlabeltext{\currentbtxalternative:and} },
   \c!finalnamesep={ \btxlabeltext{\currentbtxalternative:and} },
   \c!firstnamesep={ },
 % \c!andtext={ \btxlabeltext{\currentbtxalternative:and} },
   \c!otherstext={ \btxlabeltext{\currentbtxalternative:others}},
   \c!juniorsep={ },
   \c!vonsep={ },
   \c!initialsep={ },
   \c!surnamesep={, },
   \c!surnameinitialsep={, },
   \c!surnamefirstnamesep={, },
   \c!etallimit=5,
   \c!etaldisplay=\btxlistvariantparameter\c!etallimit,
   %c!journalconversion=\v!normal,
   \c!monthconversion=\v!number,
   \c!authorconversion=\v!normal]

\definebtxlistvariant
  [author]

\definebtxlistvariant
  [editor]
  [author]

\definebtxlistvariant
  [artauthor]
  [author]

% Not that efficient but ...

\setupbtxcitevariant
  [\c!namesep=\btxlistvariantparameter\c!namesep,
   \c!lastnamesep=\btxlistvariantparameter\c!lastnamesep,
   \c!finalnamesep=\btxlistvariantparameter\c!finalnamesep,
   \c!firstnamesep=\btxlistvariantparameter\c!firstnamesep,
   \c!juniorsep=\btxlistvariantparameter\c!juniorsep,
   \c!vonsep=\btxlistvariantparameter\c!vonsep,
   \c!initialsep=\btxlistvariantparameter\c!initialsep,
   \c!surnamesep=\btxlistvariantparameter\c!surnamesep,
   \c!surnameinitialsep=\btxlistvariantparameter\c!surnameinitialsep,
   \c!surnamefirstnamesep=\btxlistvariantparameter\c!surnamefirstnamesep,
   \c!etallimit=\btxlistvariantparameter\c!etallimit,
   \c!etaldisplay=\btxlistvariantparameter\c!etaldisplay,
   \c!otherstext=\btxlistvariantparameter\c!otherstext,
   \c!monthconversion=\btxlistvariantparameter\c!monthconversion,
   \c!authorconversion=\v!name]

% Do we want these in the format? Loading them delayed is somewhat messy.

\loadbtxdefinitionfile[commands]
\loadbtxdefinitionfile[definitions]

\loadbtxdefinitionfile[cite]
\loadbtxdefinitionfile[list]
\loadbtxdefinitionfile[author]

\setupbtx
  [\c!alternative=apa]

\protect
