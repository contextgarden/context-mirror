%D \module
%D   [       file=spac-ali,
%D        version=2009.10.16, % 1997.03.31, was core-spa.tex
%D          title=\CONTEXT\ Spacing Macros,
%D       subtitle=Alignments,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA ADE \& \CONTEXT\ Development Team}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

\writestatus{loading}{ConTeXt Spacing Macros / Alignments}

\unprotect

%D The \type {new} and \type {old} methods are gone as we now have \type
%D {flush*} variants. Starting at the last day of 2011 both methods are
%D merged into one and caching has been added, which makes switching
%D twice as fast.

\registerctxluafile{spac-ali}{1.001}

\definesystemattribute[realign]   [public] % might be combined with the next one
\definesystemattribute[alignstate][public] % will make a single attributes for several states

\appendtoks
    \attribute\realignattribute   \attributeunsetvalue
    \attribute\alignstateattribute\attributeunsetvalue
\to \everyforgetall

\unexpanded\def\resetrealignsignal{\attribute\realignattribute\attributeunsetvalue}
\unexpanded\def\signalinnerrealign{\ctxcommand{setrealign(2)}}
\unexpanded\def\signalouterrealign{\ctxcommand{setrealign(1)}}

\installcorenamespace{aligncommand}
\installcorenamespace{alignhorizontal}
\installcorenamespace{alignvertical}
\installcorenamespace{alignmentcache}

\newtoks\everyresetalign % todo

% We will not use bodydir and pagedir so we disable them. That way we get
% normal hyperlink support.

\let\saved_normal_body_dir\normalbodydir
\let\saved_normal_page_dir\normalpagedir

\unexpanded\def\bodydir{\afterassignment\bodydir_indeed\saved_normal_body_dir} \let\normalbodydir\bodydir
\unexpanded\def\pagedir{\afterassignment\pagedir_indeed\saved_normal_page_dir} \let\normalpagedir\pagedir

\def\bodydir_indeed{\saved_normal_body_dir TLT\relax}
\def\pagedir_indeed{\saved_normal_page_dir TLT\relax}

% This will become a more advanced layout controller soon:

\newconditional\layoutlefttoright   \settrue\layoutlefttoright
\newconditional\displaylefttoright  \settrue\displaylefttoright
\newconditional\inlinelefttoright   \settrue\inlinelefttoright

\unexpanded\def\lefttoright
  {\ifvmode
     \lefttoright_vmode
   \else
     \lefttoright_hmode
   \fi}

\unexpanded\def\lefttoright_vmode
  {\settrue\displaylefttoright
   \settrue\inlinelefttoright
   \textdir TLT\relax
   \pardir  TLT\relax}

\unexpanded\def\lefttoright_hmode
  {\settrue\inlinelefttoright
   \textdir TLT\relax}

\unexpanded\def\righttoleft
  {\ifvmode
     \righttoleft_vmode
   \else
     \righttoleft_hmode
   \fi}

\unexpanded\def\righttoleft_vmode
  {\setfalse\displaylefttoright
   \setfalse\inlinelefttoright
   \textdir TRT\relax
   \pardir  TRT\relax}

\unexpanded\def\righttoleft_hmode
  {\textdir TRT\relax
   \setfalse\inlinelefttoright}

\def\currentdirectionparameters
  {\ifconditional\inlinelefttoright \else
      idir="r2l",
   \fi
   \ifconditional\displaylefttoright \else
      ddir="r2l",
   \fi}

\unexpanded\def\synchronizelayoutdirection
  {\ifconditional\layoutlefttoright
     \synchronizedirection_lr
   \else
     \synchronizedirection_rl
   \fi}

\unexpanded\def\synchronizedisplaydirection
  {\ifconditional\displaylefttoright
     \synchronizedirection_lr
   \else
     \synchronizedirection_rl
   \fi}

\def\synchronizedirection_lr
  {\settrue\inlinelefttoright
   \textdir TLT\relax
   \pardir  TLT\relax}

\def\synchronizedirection_rl
  {\setfalse\inlinelefttoright
   \textdir TRT\relax
   \pardir  TRT\relax}

\unexpanded\def\synchronizeinlinedirection
  {\textdir T\ifconditional\inlinelefttoright L\else R\fi T\relax}

\unexpanded\def\showdirections
  {\dontleavehmode
   \begingroup\infofont\textdir TLT[\space
   layout:\ifconditional \layoutlefttoright  l2r\else r2l\fi\space
   display:\ifconditional\displaylefttoright l2r\else r2l\fi\space
   inline:\ifconditional \inlinelefttoright  l2r\else r2l\fi\space
   ]\endgroup}

% Tolerance and hyphenation

\newcount\hyphenminoffset

\ifx\sethyphenationvariables\undefined \let\sethyphenationvariables\relax \fi

\unexpanded\def\lesshyphens
  {\advance\hyphenminoffset\plusone
   \sethyphenationvariables}

\unexpanded\def\morehyphens
  {\ifcase\hyphenminoffset \else
     \advance\hyphenminoffset\minusone
   \fi
   \sethyphenationvariables}


\unexpanded\def\nohyphens % % % % % not clever, we still hyphenate but supress application
  {\ifx\dohyphens\relax
     \edef\dohyphens
       {\hyphenpenalty  \the\hyphenpenalty
        \exhyphenpenalty\the\exhyphenpenalty
        \relax}%
   \fi
   \hyphenpenalty\plustenthousand
   \exhyphenpenalty\plustenthousand}

\let\dohyphens\relax

\newcount\c_spacing_minimum_tolerance  \c_spacing_minimum_tolerance = 1500
\newcount\c_spacing_normal_tolerance   \c_spacing_normal_tolerance  = 3000
\newcount\c_spacing_extreme_tolerance  \c_spacing_extreme_tolerance = 4500

\def\spacing_raggedness_left  {\plustwo\bodyfontsize}
\def\spacing_raggedness_right {\plustwo\bodyfontsize}
\def\spacing_raggedness_middle{\plussix\bodyfontsize} % overloaded below

% oeps, hsize can be 0pt in which case we get a strange division
% was: 6\bodyfontsize, fails on: \placefigure{x $x=x$ x}{}

\def\spacing_raggedness_middle{\ifdim\hsize=\zeropoint\plussix\bodyfontsize\else.5\hsize\fi}

\unexpanded\def\setraggedness#1% tricky .. we keep the global tolerance otherwise ... to be reconsidered
  {\ifnum\tolerance<\c_spacing_minimum_tolerance
     \tolerance\c_spacing_minimum_tolerance % small values have unwanted side effects
   \else
     % todo: take set value or none .. better done elsewhere (200 is normal)
   \fi
   \ifx\dohyphens\relax % was 2.5 in old implementation using scratch registers
     \hyphenpenalty\dimexpr2.8\hsize/\dimexpr#1\relax\relax % 50 in raggedright/raggedleft
   \fi}

\unexpanded\def\ragged_command_tolerant
  {\tolerance\c_spacing_normal_tolerance}

\unexpanded\def\ragged_command_very_tolerant
  {\tolerance\c_spacing_extreme_tolerance}

\unexpanded\def\ragged_command_stretch
  {\emergencystretch\bodyfontsize}

% Vertical

\newconstant\c_spacing_state_vertical

\unexpanded\def\spacing_vertical_none
  {\let\raggedtopcommand   \relax
   \let\raggedbottomcommand\relax}

\unexpanded\def\spacing_vertical_lohi
  {\let\raggedtopcommand   \vfilll
   \let\raggedbottomcommand\vfilll}

\unexpanded\def\spacing_vertical_low
  {\let\raggedtopcommand   \vfilll
   \let\raggedbottomcommand\relax}

\unexpanded\def\spacing_vertical_high
  {\let\raggedtopcommand   \relax
   \let\raggedbottomcommand\vfilll}

\def\spacing_flush_vertical
  {\ifcase\c_spacing_state_vertical
     \spacing_vertical_none
   \or
     \spacing_vertical_lohi
   \or
     \spacing_vertical_low
   \or
     \spacing_vertical_high
   \fi}

% Horizontal

\ifdefined\raggedonelinerstate \else
    \newconditional\raggedonelinerstate  % public
\fi

\newconstant\raggedstatus % public

\newconstant\c_spacing_state_horizontal
\newconstant\c_spacing_state_broad

\def\spacing_ragged_fill_amount          {\plusone  fil}
\def\spacing_ragged_fill_amount_negative {\minusone fil}
\def\spacing_ragged_fill_amount_double   {\plustwo  fil}
\def\spacing_ragged_fill_amount_space    {\plustwo  fil} % can be added to xspace if we have a key
\def\spacing_ragged_fill_amount_half             {.5fil}
\let\spacing_ragged_space_amount         \interwordspace
\def\spacing_ragged_space_amount_x          {.5\emwidth}

\newskip\s_zero_plus_one_fil \s_zero_plus_one_fil = 0pt plus 1fil
\newskip\s_zero_plus_zero    \s_zero_plus_zero    = 0pt plus 0pt

% \!!plus ... slower than inline

\unexpanded\def\spacing_horizontal_none
  {\raggedstatus\zerocount
   \attribute\alignstateattribute\attributeunsetvalue
   \leftskip   \plusone\leftskip
   \rightskip  \plusone\rightskip
   \spaceskip  \zeropoint
   \xspaceskip \zeropoint
   \parfillskip\s_zero_plus_one_fil} % new

\unexpanded\def\spacing_horizontal_left
  {\setraggedness\spacing_raggedness_left
   \raggedstatus\plusone
   \attribute\alignstateattribute\plusone
   \leftskip   \plusone\leftskip \!!plus\spacing_raggedness_left
   \rightskip  \plusone\rightskip\!!plus\zeropoint
   \spaceskip  \spacing_ragged_space_amount
   \xspaceskip \spacing_ragged_space_amount_x
   \parfillskip\s_zero_plus_zero
   \parindent  \zeropoint
   \relax}

\unexpanded\def\spacing_horizontal_center
  {\setraggedness\spacing_raggedness_middle
   \raggedstatus\plustwo
   \attribute\alignstateattribute\plustwo
   \leftskip   \plusone\leftskip \!!plus\spacing_raggedness_middle
   \rightskip  \plusone\rightskip\!!plus\spacing_raggedness_middle
   \spaceskip  \spacing_ragged_space_amount
   \xspaceskip \spacing_ragged_space_amount_x
   \parfillskip\s_zero_plus_zero
   \parindent  \zeropoint
   \relax}

\unexpanded\def\spacing_horizontal_right
  {\setraggedness\spacing_raggedness_right
   \raggedstatus\plusthree
   \attribute\alignstateattribute\plusthree
   \leftskip   \plusone\leftskip \!!plus\zeropoint
   \rightskip  \plusone\rightskip\!!plus\spacing_raggedness_right
   \spaceskip  \spacing_ragged_space_amount
   \xspaceskip \spacing_ragged_space_amount_x
   \parfillskip\s_zero_plus_one_fil
  %\parindent  \parindent
   \relax}

\unexpanded\def\spacing_horizontal_very_left
  {\raggedstatus\plusone
   \attribute\alignstateattribute\plusone
   \leftskip   \plusone\leftskip \!!plus\spacing_ragged_fill_amount
   \rightskip  \plusone\rightskip\!!plus\zeropoint
   \spaceskip  \spacing_ragged_space_amount
   \xspaceskip \spacing_ragged_space_amount_x
   \parfillskip\s_zero_plus_zero
   \parindent  \zeropoint
   \relax}

\unexpanded\def\spacing_horizontal_very_center
  {\raggedstatus\plustwo
   \attribute\alignstateattribute\plustwo
   \leftskip   \plusone\leftskip \!!plus\spacing_ragged_fill_amount
   \rightskip  \plusone\rightskip\!!plus\spacing_ragged_fill_amount
   \spaceskip  \spacing_ragged_space_amount
   \xspaceskip \spacing_ragged_space_amount_x
   \parfillskip\s_zero_plus_zero
   \parindent  \zeropoint
   \relax}

\unexpanded\def\spacing_horizontal_very_right
  {\raggedstatus\plusthree
   \attribute\alignstateattribute\plusthree
   \leftskip   \plusone\leftskip \!!plus\zeropoint
   \rightskip  \plusone\rightskip\!!plus\spacing_ragged_fill_amount
   \spaceskip  \spacing_ragged_space_amount
   \xspaceskip \spacing_ragged_space_amount_x
   \parfillskip\s_zero_plus_zero
  %\parindent  \parindent
   \relax}

\unexpanded\def\spacing_horizontal_wide_center
  {\setraggedness\spacing_raggedness_middle
   \raggedstatus\plustwo
   \attribute\alignstateattribute\plustwo
   \leftskip   \plusone\leftskip \!!plus\spacing_ragged_fill_amount_half
   \rightskip  \plusone\rightskip\!!plus\spacing_ragged_fill_amount_half
   \spaceskip  \spacing_ragged_space_amount
   \xspaceskip \spacing_ragged_space_amount_x
   \parfillskip\s_zero_plus_zero
   \parindent  \zeropoint
   \relax}

\unexpanded\def\spacing_horizontal_centered_last_line
  {\raggedstatus\zerocount
   \attribute\alignstateattribute\attributeunsetvalue
   \leftskip   \plusone\leftskip \!!plus\spacing_ragged_fill_amount\relax
   \rightskip  \plusone\rightskip\!!plus\spacing_ragged_fill_amount_negative\relax
   \spaceskip  \zeropoint\relax
   \xspaceskip \zeropoint\relax
   \parfillskip\zeropoint\!!plus\spacing_ragged_fill_amount_double\relax
   \parindent  \zeropoint
   \relax}

\unexpanded\def\spacing_horizontal_right_tt % a plain command
  {\tttf % brrr
   \raggedstatus\plusthree
   \attribute\alignstateattribute\plusthree
   \leftskip   \plusone\leftskip \!!plus\zeropoint\relax
   \rightskip  \plusone\rightskip\!!plus\spacing_raggedness_right\relax
   \spaceskip  \zeropoint\relax
   \xspaceskip \zeropoint\relax
   \parfillskip\s_zero_plus_zero
  %\parindent  \parindent
   \relax}

\unexpanded\def\spacing_horizontal_extra
  {\xspaceskip\zeropoint\!!plus\spacing_ragged_fill_amount_space\relax}

\def\spacing_flush_horizontal
  {\ifcase\c_spacing_state_horizontal
     % 0
     \spacing_horizontal_none
   \or
     % 1 center
     \ifcase\c_spacing_state_broad
       \spacing_horizontal_center
     \or
       \spacing_horizontal_very_center
     \or
       \spacing_horizontal_wide_center
     \fi
   \or
     % 2 flush left
     \ifcase\c_spacing_state_broad
       \spacing_horizontal_right
     \else
       \spacing_horizontal_very_right
     \fi
   \or
     % 3 flush right
     \ifcase\c_spacing_state_broad
       \spacing_horizontal_left
     \else
       \spacing_horizontal_very_left
     \fi
   \or
     % 4 inner
     \ifdoublesided
       \signalinnerrealign
     \fi
     \rightorleftpageaction\spacing_horizontal_right\spacing_horizontal_left
   \or
     % 5 outer
     \ifdoublesided
       \signalouterrealign
     \fi
     \rightorleftpageaction\c_spacing_state_horizontal_left\spacing_horizontal_right
   \or
     % 6 oneliner
     \ifcase\c_spacing_state_broad
       \spacing_horizontal_right
     \else
       \spacing_horizontal_very_right
     \fi
     \parfillskip\zeropoint
   \or
     % 7 centered last line
     \spacing_horizontal_centered_last_line
   \fi}

% Page spacing:

\newconstant\c_spacing_state_page

\def\bottomalignlimit{\plusthree\lineheight}

\newconstant\bottomraggednessmode % 0=ragged 1=normal/align 2=baseline

\unexpanded\def\raggedbottom
  {\bottomraggednessmode\zerocount
   \settopskip}

\unexpanded\def\alignbottom
  {\bottomraggednessmode\plusone
   \settopskip}

\unexpanded\def\baselinebottom
  {\bottomraggednessmode\plustwo
   \settopskip}

\let\normalbottom\alignbottom % downward compatible

\unexpanded\def\setbottomalignmode#1%
  {\bottomraggednessmode#1%
   \settopskip}

\def\spacing_flush_page
  {\ifcase\c_spacing_state_page
     % keep state
   \or
     \raggedbottom
   \or
     \alignbottom
   \or
     \baselinebottom
   \fi}

% Directions

\newconstant\c_spacing_state_direction

\def\spacing_flush_direction
  {\ifcase\c_spacing_state_direction
    % keep state
   \or
     \lefttoright
   \or
     \righttoleft
   \fi}

% Interesting is that the non cached version is also pretty efficient
% and as we cache we seldom call that one now so one can debate the
% speedup.

\newtoks\t_spacing_set_alignment

\let\raggedcommand    \relax
\let\updateraggedskips\relax

% \unexpanded\def\spacing_set_text_align#1% beware: #1=empty is ignored, keep that! assumes \forgetall ... needs checking
%   {\edef\askedraggedalign{#1}%
%    \ifx\askedraggedalign\empty
%      \spacing_set_text_align_nop
%    \else
%      \spacing_set_text_align_yes
%    \fi}

% \def\spacing_set_text_align_nop % as we cache (empty) anyway, this one can go
%   {%\let\raggedtopcommand   \relax
%    %\let\raggedbottomcommand\relax
%    \let\raggedbox           \relax % why
%    \t_spacing_set_alignment
%      {\resetrealignsignal
%       \setfalse\raggedonelinerstate
%       \let\raggedtopcommand   \relax
%       \let\raggedbottomcommand\relax}}

% \def\spacing_set_text_align_yes % hm, we could hash settings ! nice experiment
%   {%\let\raggedtopcommand\empty
%    %\let\raggedbottomcommand\empty
%    \let\raggedbox\relax % why
%    % we inherit hyphenation and tolerance
%    \t_spacing_set_alignment   \emptytoks
%    \c_spacing_state_broad     \zerocount
%    \c_spacing_state_horizontal\zerocount
%    \c_spacing_state_vertical  \zerocount
%    \c_spacing_state_direction \zerocount % what is default ?
%    \c_spacing_state_page      \zerocount
%    \ifcsname\??aligncommand\askedraggedalign\endcsname
%      \csname\??aligncommand\askedraggedalign\endcsname
%    \else
%      \rawprocesscommacommand[\askedraggedalign]\spacing_set_text_align_collect
%    \fi
%    \normalexpanded{\t_spacing_set_alignment
%      {\resetrealignsignal % can go as it is alway set
%       \setfalse\raggedonelinerstate % bad
%       \the\t_spacing_set_alignment
%       \spacing_flush_horizontal
%       \spacing_flush_vertical
%       \spacing_flush_direction
%       \spacing_flush_page
%       }}} % kept

\unexpanded\def\spacing_set_text_align#1% what to do with empty (and forgetall)
  {\edef\askedraggedalign{#1}%
   \let\raggedbox\relax % why
   % we inherit hyphenation and tolerance
   \t_spacing_set_alignment   \emptytoks
   \c_spacing_state_broad     \zerocount
   \c_spacing_state_horizontal\zerocount
   \c_spacing_state_vertical  \zerocount
   \c_spacing_state_direction \zerocount % what is default ?
   \c_spacing_state_page      \zerocount
   \ifcsname\??aligncommand\askedraggedalign\endcsname
     \csname\??aligncommand\askedraggedalign\endcsname % not much gain in new method
   \else
     \rawprocesscommacommand[\askedraggedalign]\spacing_set_text_align_collect
   \fi
   \normalexpanded{\t_spacing_set_alignment
     {\resetrealignsignal % can go as it is alway set
      \setfalse\raggedonelinerstate % bad
      \the\t_spacing_set_alignment
      \spacing_flush_horizontal
      \spacing_flush_vertical
      \spacing_flush_direction
      \spacing_flush_page
      }}} % kept

\def\spacing_set_text_align_collect#1%
  {\csname\??aligncommand#1\endcsname}

\def\spacing_alignment_add_to_cache#1%
  {\spacing_set_text_align{#1}
   \edef\raggedcommand{\the\t_spacing_set_alignment}%
   \global\expandafter\let\csname\??alignmentcache#1\endcsname\raggedcommand}

% The regular align setter:

\unexpanded\def\setupalign
  {\dosingleempty\spacing_setup_align}

\def\spacing_setup_align[#1]% immediate
  {\expandafter\let\expandafter\raggedcommand\csname\??alignmentcache#1\endcsname
   \ifx\raggedcommand\relax
     \spacing_alignment_add_to_cache{#1}%
   \fi
   \let\updateraggedskips\raggedcommand
   \raggedcommand}

% the local (key driven) setter:

\unexpanded\def\spacing_setup_aligned#1% deferred
  {\expandafter\let\expandafter\raggedcommand\csname\??alignmentcache#1\endcsname
   \ifx\raggedcommand\relax
     \spacing_alignment_add_to_cache{#1}%
   \fi
   \let\updateraggedskips\raggedcommand}

\let\dosetraggedcommand\spacing_setup_aligned % sort of public

% The keywords:

\unexpanded\def\installalign#1#2% beware: commands must be unexpandable!
  {\ifcsname\??aligncommand#1\endcsname \else
     \setvalue{\??aligncommand#1}{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment#2}}%
   \fi}

\letvalue{\??aligncommand\empty            }\empty
\setvalue{\??aligncommand\v!broad          }{\c_spacing_state_broad     \plusone  }
\setvalue{\??aligncommand\v!wide           }{\c_spacing_state_broad     \plustwo  }

\setvalue{\??aligncommand\v!bottom         }{\c_spacing_state_page      \plusone  }
\setvalue{\??aligncommand\v!height         }{\c_spacing_state_page      \plustwo  }
\setvalue{\??aligncommand\v!line           }{\c_spacing_state_page      \plusthree
                                             % this will become another keyword (undocumented anyway)
                                             \t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\settrue\raggedonelinerstate}}

\setvalue{\??aligncommand\v!high           }{\c_spacing_state_vertical  \plusthree}
\setvalue{\??aligncommand\v!low            }{\c_spacing_state_vertical  \plustwo  }
\setvalue{\??aligncommand\v!lohi           }{\c_spacing_state_vertical  \plusone  }

\setvalue{\??aligncommand\v!flushright     }{\c_spacing_state_horizontal\plusthree}
\setvalue{\??aligncommand\v!flushleft      }{\c_spacing_state_horizontal\plustwo  }
\setvalue{\??aligncommand\v!middle         }{\c_spacing_state_horizontal\plusone  }
\setvalue{\??aligncommand\v!no             }{\c_spacing_state_horizontal\plustwo  }
\setvalue{\??aligncommand\v!yes            }{\c_spacing_state_horizontal\zerocount}
\setvalue{\??aligncommand\v!width          }{\c_spacing_state_horizontal\zerocount}
\setvalue{\??aligncommand\v!normal         }{\c_spacing_state_horizontal\zerocount}
\setvalue{\??aligncommand\v!reset          }{\c_spacing_state_page      \zerocount
                                             \c_spacing_state_horizontal\zerocount}
\setvalue{\??aligncommand\v!inner          }{\c_spacing_state_horizontal\plusfour }
\setvalue{\??aligncommand\v!outer          }{\c_spacing_state_horizontal\plusfive }
\setvalue{\??aligncommand\v!flushinner     }{\c_spacing_state_horizontal\plusfive }
\setvalue{\??aligncommand\v!flushouter     }{\c_spacing_state_horizontal\plusfour }
\setvalue{\??aligncommand\v!right          }{\c_spacing_state_horizontal\plustwo  }
\setvalue{\??aligncommand\v!left           }{\c_spacing_state_horizontal\plusthree}
\setvalue{\??aligncommand\v!center         }{\c_spacing_state_horizontal\plusone
                                             \c_spacing_state_broad     \plustwo  }
\setvalue{\??aligncommand\v!disable        }{\c_spacing_state_horizontal\plussix  }
\setvalue{\??aligncommand\v!last           }{\c_spacing_state_horizontal\plusseven}


\setvalue{\??aligncommand\v!lefttoright    }{\c_spacing_state_direction \plusone  }
\setvalue{\??aligncommand\v!righttoleft    }{\c_spacing_state_direction \plustwo  }
\setvalue{\??aligncommand               l2r}{\c_spacing_state_direction \plusone  }
\setvalue{\??aligncommand               r2l}{\c_spacing_state_direction \plustwo  }

\setvalue{\??aligncommand\v!table          }{\c_spacing_state_vertical  \plusthree
                                             \c_spacing_state_broad     \plusone
                                             \c_spacing_state_horizontal\plustwo  }

\setvalue{\??aligncommand\v!lesshyphenation}{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\lesshyphens}}
\setvalue{\??aligncommand\v!morehyphenation}{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\morehyphens}}

\setvalue{\??aligncommand\v!hanging        }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\fonts_protruding_enable }}
\setvalue{\??aligncommand\v!nothanging     }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\fonts_protruding_disable}}
\setvalue{\??aligncommand\v!hz             }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\fonts_expansion_enable  }}
\setvalue{\??aligncommand\v!nohz           }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\fonts_expansion_disable }}
\setvalue{\??aligncommand\v!spacing        }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\enablespacehandling \enablekernhandling }}
\setvalue{\??aligncommand\v!nospacing      }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\disablespacehandling\disablekernhandling}}
\setvalue{\??aligncommand\v!hyphenated     }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\dohyphens}}
\setvalue{\??aligncommand\v!nothyphenated  }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\nohyphens}}

\setvalue{\??aligncommand\v!tolerant       }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\ragged_command_tolerant}}
\setvalue{\??aligncommand\v!verytolerant   }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\ragged_command_very_tolerant}}
\setvalue{\??aligncommand\v!stretch        }{\t_spacing_set_alignment\expandafter{\the\t_spacing_set_alignment\ragged_command_stretch}}

% Visible commands:

\let\notragged       \spacing_horizontal_none
\let\forgetragged    \spacing_horizontal_none
\let\raggedleft      \spacing_horizontal_left
\let\raggedcenter    \spacing_horizontal_center
\let\raggedright     \spacing_horizontal_right
\let\veryraggedleft  \spacing_horizontal_very_left
\let\veryraggedcenter\spacing_horizontal_very_center
\let\veryraggedright \spacing_horizontal_very_right
\let\raggedwidecenter\spacing_horizontal_wide_center
\let\centeredlastline\spacing_horizontal_centered_last_line
\let\ttraggedright   \spacing_horizontal_right_tt            % a plain command

% Box commands.

\unexpanded\def\ibox#1#2#3%
  {\vbox\bgroup
     \forgetall
     \let\\=\endgraf
     \ifdoublesided\signalinnerrealign\fi
     \doifrightpageelse\spacing_horizontal_right\spacing_horizontal_left
     \let\next}

\unexpanded\def\obox#1#2#3%
  {\vbox\bgroup
     \forgetall
     \let\\=\endgraf
     \ifdoublesided\signalouterrealign\fi
     \doifrightpageelse\c_spacing_state_horizontal_left\spacing_horizontal_right
     \let\next}

\let\raggedbox\relax

\def\dosetraggedvbox#1% can be more keys
  {\let\raggedbox\vbox
   \processcommacommand[#1]\dodosetraggedvbox}

\def\dosetraggedhbox#1% can be more keys
  {\let\raggedbox\hbox
   \processcommacommand[#1]\dodosetraggedhbox}

\def\dodosetraggedvbox#1%
  {\ifcsname\??alignvertical#1\endcsname
     \csname\??alignvertical#1\endcsname
     \quitcommalist
   \fi}

\def\dodosetraggedhbox#1%
  {\ifcsname\??alignhorizontal#1\endcsname
     \csname\??alignhorizontal#1\endcsname
     \quitcommalist
   \fi}

\setvalue{\??alignvertical  \v!left      }{\let\raggedbox\lbox}
\setvalue{\??alignvertical  \v!right     }{\let\raggedbox\rbox}
\setvalue{\??alignvertical  \v!middle    }{\let\raggedbox\cbox}
\setvalue{\??alignvertical  \v!inner     }{\let\raggedbox\ibox}
\setvalue{\??alignvertical  \v!outer     }{\let\raggedbox\obox}
\setvalue{\??alignvertical  \v!flushleft }{\let\raggedbox\rbox}
\setvalue{\??alignvertical  \v!flushright}{\let\raggedbox\lbox}
\setvalue{\??alignvertical  \v!center    }{\let\raggedbox\cbox}
\setvalue{\??alignvertical  \v!no        }{\def\raggedbox{\vbox\bgroup\spacing_horizontal_right\let\next=}]}

% maybe \let's

\setvalue{\??alignhorizontal\v!left      }{\def\raggedbox{\doalignedline\v!left  }}
\setvalue{\??alignhorizontal\v!right     }{\def\raggedbox{\doalignedline\v!right }}
\setvalue{\??alignhorizontal\v!middle    }{\def\raggedbox{\doalignedline\v!middle}}
\setvalue{\??alignhorizontal\v!inner     }{\def\raggedbox{\doalignedline\v!inner }}
\setvalue{\??alignhorizontal\v!outer     }{\def\raggedbox{\doalignedline\v!outer }}
\setvalue{\??alignhorizontal\v!flushleft }{\def\raggedbox{\doalignedline\v!right }}
\setvalue{\??alignhorizontal\v!flushright}{\def\raggedbox{\doalignedline\v!left  }}
\setvalue{\??alignhorizontal\v!center    }{\def\raggedbox{\doalignedline\v!middle}}

% The next one can be in use so we keep it around but oen should
% be aware of possible interference.

\unexpanded\def\setraggedskips#1#2#3#4#5#6#7% never change this name (todo: inline this one .. less tracingall)
  {\unexpanded\def\updateraggedskips{\dosetraggedskips{#1}{#2}{#3}{#4}{#5}{#6}{#7}}%
   \updateraggedskips}

\def\dosetraggedskips#1#2#3#4#5#6#7%
  {\raggedstatus                 #1\relax
   \leftskip   1\leftskip \!!plus#2\relax
   \rightskip  1\rightskip\!!plus#3\relax
   \spaceskip                    #4\relax
   \xspaceskip                   #5\relax
   \parfillskip \zeropoint\!!plus#6\relax
   \parindent                    #7\relax
   \attribute\alignstateattribute\ifcase\raggedstatus\attributeunsetvalue\else\raggedstatus\fi}

% older (context) names:

\let\spaceamount  \interwordspace
\let\emspaceamount\emwidth

% tracing:

\def\spacing_show_par_data#1%
  {\ifx#1\relax\else
     \hbox{\string#1: \the#1}\endgraf
     \expandafter\spacing_show_par_data
   \fi}

\unexpanded\def\showpardata
  {\edef\thepardata
     {\hbox{font: \fontname\font}\endgraf
      \spacing_show_par_data
        \interwordspace \interwordstretch \interwordshrink \emwidth \exheight \extraspace
        \hsize     \vsize
        \leftskip  \rightskip
        \spaceskip \xspaceskip
        \parindent \parfillskip
        \hyphenpenalty \exhyphenpenalty
        \displaywidowpenalty \widowpenalty \clubpenalty \brokenpenalty
        \doublehyphendemerits \finalhyphendemerits \adjdemerits
      \relax}%
   \dontleavehmode
   \begingroup
   \dontshowcomposition
   \inleftmargin{\vsmash{\infofont\framed[\c!align=\v!right]{\thepardata}}}%
   \endgroup}

\unexpanded\def\startshowpardata
  {\begingroup
   \showcomposition % all this tracing can go ... if we want it back it will be done in lua
   \showstruts\tracepositionstrue \tracingparagraphs\maxdimen
   \appendtoksonce\showpardata\let\showpardata\relax\to\everypar}

\unexpanded\def\stopshowpardata
  {\endgraf
   \endgroup}

% Structure:

\unexpanded\def\startalignment
  {\begingroup
   \setupalign}

\unexpanded\def\stopalignment
  {\par
   \endgroup}

\setnewconstant\alignstrutmode\plusone

% see later for the real definition, which in the simple case is:

\newtoks \everyleftofalignedline
\newtoks \everyrightofalignedline

\unexpanded\def\shiftalignedline#1#2#3#4% left, right, inner, outer
  {\rightorleftpageaction
     {\everyleftofalignedline {\hskip\dimexpr#1+#3\relax}%
      \everyrightofalignedline{\hskip\dimexpr#2+#4\relax}}
     {\everyleftofalignedline {\hskip\dimexpr#1+#4\relax}%
      \everyrightofalignedline{\hskip\dimexpr#2+#3\relax}}}

\def\doalignline#1#2% \\ == newline
  {\noindentation  % was \noindent
   \dontleavehmode % added in marrakesch at TUG 2006\begingroup
   \begingroup
   \setlocalhsize % new
   \def\\{\endgroup\par\doalignline{#1}{#2}\begingroup}%
   \dowithnextbox
     {\hbox to \localhsize
        {\ifcase\alignstrutmode\or\strut\fi
         \the\everyleftofalignedline
         #1\unhbox\nextbox#2\relax
         \the\everyrightofalignedline}%
      \endgroup}
     \hbox}

% plain commands

\ifdefined\line       \else \def\line        {\hbox to\hsize}    \fi
\ifdefined\leftline   \else \def\leftline  #1{\line{#1\hss}}     \fi
\ifdefined\rightline  \else \def\rightline #1{\line{\hss#1}}     \fi
\ifdefined\centerline \else \def\centerline#1{\line{\hss#1\hss}} \fi

% direct commands

\unexpanded\def\leftaligned {\doalignline\relax \hss  }
\unexpanded\def\midaligned  {\doalignline\hss   \hss  }
\unexpanded\def\rightaligned{\doalignline\hss   \relax}
\unexpanded\def\maxaligned  {\doalignline\relax \relax}

\let\centeraligned\midaligned

% indirect commands

\installcorenamespace{alignline}

\letvalue{\??alignline\v!left      }\leftaligned
\letvalue{\??alignline\v!right     }\rightaligned
\letvalue{\??alignline\v!middle    }\midaligned
\letvalue{\??alignline\v!flushleft }\rightaligned
\letvalue{\??alignline\v!flushright}\leftaligned
\letvalue{\??alignline\v!center    }\midaligned
\letvalue{\??alignline\v!max       }\maxaligned

\def\doalignedline#1{\resetrealignsignal\csname\??alignline#1\endcsname}

%D Experimental (will be redone when floats are redone as it's real messy
%D now). It can also be made faster (if needed).

\def\doxalignline#1#2#3#4#5#6%
  {\noindentation  % was \noindent
   \dontleavehmode % added in marrakesch at TUG 2006\begingroup
   \begingroup
   \setlocalhsize
   \def\\{\endgroup\par\doxalignline#1#2#3#4#5#6\begingroup}% inefficient
   \dowithnextbox
     {\hbox to \localhsize
        {#1\hskip\ifdone#2\else#3\fi#4%
         \hbox to \localhsize
           {\the\everyleftofalignedline
            \ifcase\alignstrutmode\or\strut\fi
            \ifdone#5\unhbox\nextbox#6\else#6\unhbox\nextbox#5\fi
            \the\everyrightofalignedline}%
         \hss}%
        \endgroup}
     \hbox}

\def\doxcheckline % used for floats so multipass anyway
  {\signalrightpage\doifrightpageelse\donetrue\donefalse}

\setvalue{\??alignline\v!inner      }{\doxalignline\doxcheckline++\zeropoint       \relax\hss  }
\setvalue{\??alignline\v!outer      }{\doxalignline\doxcheckline++\zeropoint       \hss  \relax}
\setvalue{\??alignline\v!innermargin}{\doxalignline\doxcheckline-+\innermargintotal\relax\hss  }
\setvalue{\??alignline\v!outermargin}{\doxalignline\doxcheckline+-\outermargintotal\hss  \relax}
\setvalue{\??alignline\v!inneredge  }{\doxalignline\doxcheckline-+\inneredgetotal  \relax\hss  }
\setvalue{\??alignline\v!outeredge  }{\doxalignline\doxcheckline+-\outeredgetotal  \hss  \relax}
\setvalue{\??alignline\v!backspace  }{\doxalignline\doxcheckline-+\backspace       \relax\hss  }
\setvalue{\??alignline\v!cutspace   }{\doxalignline\doxcheckline+-\cutspace        \hss  \relax}

\setvalue{\??alignline\v!leftmargin }{\doxalignline\donefalse   --\leftmargintotal \hss  \relax}
\setvalue{\??alignline\v!rightmargin}{\doxalignline\donefalse   ++\rightmargintotal\relax\hss  }
\setvalue{\??alignline\v!leftedge   }{\doxalignline\donefalse   --\leftedgetotal   \hss  \relax}
\setvalue{\??alignline\v!rightedge  }{\doxalignline\donefalse   ++\rightedgetotal  \relax\hss  }

\def\doalignedline#1% unchecked
  {\csname\??alignline#1\endcsname}

\def\alignedline#1#2% setting default
  {\csname\??alignline\ifcsname\??alignline#1\endcsname#1\else#2\fi\endcsname}

% beware: \wordright{whatever\kern-\rightskip} should work!
% so, no funny boxing here

\unexpanded\def\wordright
  {\dosingleempty\spacing_word_right}

\def\spacing_word_right[#1]%
  {% don't change
   \groupedcommand
     {\removeunwantedspaces
      \hfill
      \allowbreak % changed back from \hskip\zeropoint
      \strut
      \hfill
      \quad % decent spacing
      \hbox}
     {\doifelse{#1}\v!right{\kern-\rightskip}{\doifsomething{#1}{\kern-#1}}%
      \parfillskip\zeropoint
      \finalhyphendemerits\zerocount % yes or no (see hyhenation/specialcases-001.tex)
      \par}}

% \dorecurse{5}{something} \wordright{--someone} \endgraf
% \dorecurse{6}{something} \wordright{--someone} \endgraf
% \dorecurse{7}{something} \wordright{--someone} \endgraf
%
% \dorecurse{5}{something} \wordright{--someone else entirely} \endgraf
% \dorecurse{6}{something} \wordright{--someone else entirely} \endgraf
% \dorecurse{7}{something} \wordright{--someone else entirely} \endgraf
%
% \wordright[\rightskip]{whatever}

% \simplealignedbox{2cm}{right}{x}

\installcorenamespace{alignsimple}

\setvalue{\??alignsimple\v!right     }#1{{#1\hss}}
\setvalue{\??alignsimple\v!left      }#1{{\hss#1}}
\setvalue{\??alignsimple\v!flushright}#1{{\hss#1}}
\setvalue{\??alignsimple\v!flushleft }#1{{#1\hss}}
\setvalue{\??alignsimple\v!middle    }#1{{\hss#1\hss}}

\unexpanded\def\simplealignedbox#1#2%
  {\hbox to #1\csname\??alignsimple\ifcsname\??alignsimple#2\endcsname#2\else\v!right\fi\endcsname}

% \installnamespace{alignsets}
%
% \setvalue{\??alignsets\v!right     }#1#2{\let#1\relax\let#2\hss  }
% \setvalue{\??alignsets\v!left      }#1#2{\let#1\hss  \let#2\relax}
% \setvalue{\??alignsets\v!flushright}#1#2{\let#1\hss  \let#2\relax}
% \setvalue{\??alignsets\v!flushleft }#1#2{\let#1\relax\let#2\hss  }
% \setvalue{\??alignsets\v!middle    }#1#2{\let#1\hss  \let#2\hss  }
% \setvalue{\??alignsets\v!low       }#1#2{\let#1\vss  \let#2\relax}
% \setvalue{\??alignsets\v!high      }#1#2{\let#1\relax\let#2\vss  }
% \setvalue{\??alignsets\v!lohi      }#1#2{\let#1\vss  \let#2\vss  }
% \setvalue{\??alignsets\s!unknown   }#1#2{\let#1\relax\let#2\relax}
%
% \unexpanded\def\spac_align_set_ss#1%
%   {\csname\??alignsetss\ifcsname\??alignsetss#1\endcsname#1\else\s!unknown\fi\endcsname}

% Some obsolete (old) helpers:

\def\dodefinehbox[#1][#2]%
  {\setvalue{hbox#1}##1{\hbox to #2{\begstrut##1\endstrut\hss}}}

\unexpanded\def\definehbox
  {\dodoubleargument\dodefinehbox}

\protect \endinput

% \newskip\@@raggedskipa
% \newskip\@@raggedskipb
%
% \newcount\c_spacing_minimum_tolerance \c_spacing_minimum_tolerance = 1500
%
% \unexpanded\def\setraggedness#1%
%   {\ifnum\tolerance<\c_spacing_minimum_tolerance    % small values have
%      \tolerance\c_spacing_minimum_tolerance         % unwanted side effects
%    \fi
%    \ifx\dohyphens\relax
%      % this code will be reconsidered / kind of fuzzy (and old)
%      \@@raggedskipa 2.5\hsize
%      \@@raggedskipb  #1\relax
%      \divide\@@raggedskipa \@@raggedskipb
%      \hyphenpenalty\@@raggedskipa
%    \fi}

% \installalign \v!inner         {\setraggedparagraphmode\spacing_align_rl\spacing_align_rr}
% \installalign \v!outer         {\setraggedparagraphmode\spacing_align_rr\spacing_align_rl}
% \installalign \v!flushouter    {\setraggedparagraphmode\spacing_horizontal_left \spacing_horizontal_right}
% \installalign \v!flushinner    {\setraggedparagraphmode\spacing_horizontal_right\spacing_horizontal_left }
