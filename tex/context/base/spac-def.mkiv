%D \module
%D   [       file=spac-def,
%D        version=2009.10.16, % 1997.03.31, was core-spa.tex
%D          title=\CONTEXT\ Spacing Macros,
%D       subtitle=Definitions,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA ADE \& \CONTEXT\ Development Team}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

\writestatus{loading}{ConTeXt Spacing Macros / Definitions}

% todo: move resetters to other modules

\unprotect

\unexpanded\def\forgeteverypar
  {\everypar{\the\neverypar}}

% worth trying:
%
% \unexpanded\def\forgeteverypar
%   {\everypar\neverypar}

\unexpanded\def\forgetparskip
  {\s_spac_whitespace_parskip\zeropoint
   \parskip\zeropoint
   \let\v_spac_whitespace_current\v!none}

\unexpanded\def\forgetbothskips
  {\leftskip\zeropoint
   \rightskip\zeropoint
   \relax}

\unexpanded\def\forgethorizontalstretch
  {\emergencystretch\zeropoint}

\unexpanded\def\forgetverticalstretch
  {\spacing\plusone}

\newif\ifforgotten % rather good signal for inner

% This will become better: several resetters that do all in once as currently there is
% redundant code.

\appendtoks \forgottentrue             \to \everyforgetall
\appendtoks \forgetragged              \to \everyforgetall
\appendtoks \forgetparskip             \to \everyforgetall
\appendtoks \forgetparindent           \to \everyforgetall
\appendtoks \forgetbothskips           \to \everyforgetall
\appendtoks \forgethorizontalstretch   \to \everyforgetall % needed in pagebody
\appendtoks \forgetverticalstretch     \to \everyforgetall % needed in otr
\appendtoks \everypar\emptytoks        \to \everyforgetall % indeed!

\appendtoks \forgetverticalstretch     \to \everybodyfont
\appendtoks \presetnormallineheight    \to \everybodyfont
\appendtoks \setnormalbaselines        \to \everybodyfont % check if redundant (\forgetverticalstretch does it too)
\appendtoks \setstrut                  \to \everybodyfont % check if redundant (\forgetverticalstretch does it too)
\appendtoks \settopskip                \to \everybodyfont % factors set in \forgetverticalstretch
\appendtoks \setmaxdepth               \to \everybodyfont % factors set in \forgetverticalstretch
\appendtoks \synchronizeindenting      \to \everybodyfont
\appendtoks \synchronizeblank          \to \everybodyfont
\appendtoks \synchronizewhitespace     \to \everybodyfont
\appendtoks \synchronizespacecodes     \to \everybodyfont % not needed, frozen factors
\appendtoks \setrelativeinterlinespace \to \everybodyfont

\appendtoks  \updateraggedskips        \to \everyfontswitch     % under test
\prependtoks \let\par\normalpar        \to \everybeforepagebody % see \fillinline (was endgraf)
\appendtoks  \synchronizespacecodes    \to \everydefinedfont    % not needed, frozen factors

\setupwhitespace
  [\v!none]

\indenting
  [\v!never]

\setupindenting
  [\v!none]

\setupvspacing % == \setupblank
  [\v!standard,
   \v!big]

\definevspacing[\v!default]  [\v!big]      % todo: needs to adapt to \setupblank
\definevspacing[\v!before]   [\v!default]  % but we need to avoid circular references
\definevspacing[\v!inbetween][\v!default]  % then
\definevspacing[\v!after]    [\v!before]

\setupinterlinespace
  [\c!minheight=\zeropoint, % only special purpose
   \c!mindepth=\zeropoint, % only special purpose
   \c!height=.72,
   \c!depth=.28,
   \c!top=1.0,
   \c!bottom=0.4,
   \c!distance=\onepoint,
   \c!line=2.8\exheight,
   \c!stretch=\zerocount]

\setupnarrower
  [\c!before=\endgraf,
   \c!after=\endgraf,
   \c!left=1.5\emwidth,
   \c!right=1.5\emwidth,
   \c!middle=1.5\emwidth]

\setuptolerance
  [\v!horizontal,\v!verystrict]

\setuptolerance
  [\v!vertical,\v!strict]

\setupalign
  [\v!bottom,
   \v!width]

\setupspacing
  [\v!packed]

\protect \endinput
