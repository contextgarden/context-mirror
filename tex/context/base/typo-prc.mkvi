%D \module
%D   [       file=typo-prc,
%D        version=2008.10.20,
%D          title=\CONTEXT\ Structure Macros,
%D       subtitle=Processors,
%D         author=Hans Hagen,
%D           date=\currentdate,
%D      copyright={PRAGMA ADE \& \CONTEXT\ Development Team}]
%C
%C This module is part of the \CONTEXT\ macro||package and is
%C therefore copyrighted by \PRAGMA. See mreadme.pdf for
%C details.

\writestatus{loading}{ConTeXt Typesetting Macros / Processors}

\registerctxluafile{typo-prc}{1.001}

\unprotect

%D Processors are used when we cannot easily associate typesetting directives
%D with (for instance) structural elements. Instead of ending up with numerous
%D additional definitions we can group treatments in so called processors.
%D
%D An example of where processors can be used is in separator sets (these are
%D related to typesetting numbers using structure).
%D
%D \starttyping
%D \defineprocessor[demo][style=\bfb,color=red]
%D \stoptyping
%D
%D This defines a processor named \type {demo}. Such a name ends up as prefix in
%D for instance:
%D
%D \starttyping
%D \definestructureseparatorset [demosep] [demo->!,demo->?,demo->!,demo->?] [demo->@]
%D \stoptyping
%D
%D Here the \type {!} and \type {?} are just the seperator characters that end
%D up between part, chapter, section, etc.\ numbers. The third argument defines the
%D default. When a separator is inserted, the \type{demo} processor will be applied.
%D Here the number will be separated by red slightly bigger than normal bold
%D exclamation marks and questionmarks
%D
%D Valid keys for defining a processor are \type {style}, \type {color}, \type {left},
%D \type {right}, and \type {command} (the given command takes one argument).

\installcommandhandler \??po {processor} \??po

\appendtoks
    \letvalue{\??po\currentprocessor\s!check}\relax
    \ctxcommand{registerstructureprocessor("\currentprocessor")}% global, but it permits using processor that are yet undefined
\to \everydefineprocessor

%D The following command can be used by users but normally it will be
%D invoked behind the screens. After all, processor prefixes need to
%D be split off first. At the \LUA\ end we do check for a processor
%D being registered anyway.

\unexpanded\def\applyprocessor#tag%
  {\def\currentprocessor{#tag}%
   \ifcsname\??po\currentprocessor\s!check\endcsname
     \expandafter\apply_processor
   \else
     \expandafter\firstofoneargument
   \fi}

\def\apply_processor
  {\doifelse{\processorparameter\c!state}\v!stop
     \firstofoneargument
     \apply_processor_indeed}

\def\apply_processor_indeed#content%
  {\begingroup
   \useprocessorstyleandcolor\c!style\c!color
   \processorparameter\c!left
   \processorparameter\c!command{#content}%
   \processorparameter\c!right
   \endgroup}

%D \startbuffer
%D \defineprocessor[first]        [style=bold]
%D \defineprocessor[last] [first] [color=red]
%D
%D \applyprocessor{first}{hans} \applyprocessor{last}{hagen}
%D \stopbuffer
%D
%D \typebuffer \start \blank \getbuffer \blanl \stop

\protect \endinput
